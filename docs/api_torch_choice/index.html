
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://gsbdbi.github.io/torch-choice/api_torch_choice/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.13">
    
    
      
        <title>API Reference Torch-Choice - Torch Choice</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e411adfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference-torch-choice" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Torch Choice" class="md-header__button md-logo" aria-label="Torch Choice" data-md-component="logo">
      
  
  <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="500.000000pt" height="500.000000pt" viewBox="0 0 500.000000 500.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,500.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M3039 4192 c-24 -15 -53 -32 -64 -38 -16 -9 -19 -19 -15 -55 2 -24 4
-60 4 -79 l1 -35 -83 -3 c-81 -3 -83 -3 -102 -35 -23 -38 -35 -87 -23 -96 4
-3 30 -32 56 -63 47 -55 48 -57 28 -70 -12 -7 -21 -20 -21 -28 0 -8 -18 -28
-40 -43 -45 -32 -47 -43 -21 -106 22 -53 34 -59 127 -60 86 -1 87 -4 78 -105
l-6 -71 62 -33 c35 -17 69 -32 77 -32 8 0 38 23 67 50 66 62 92 65 150 13 22
-20 43 -40 44 -45 2 -4 -38 -8 -88 -8 -106 0 -151 -19 -174 -73 -7 -18 -25
-38 -39 -46 -23 -12 -34 -11 -93 5 -78 22 -87 37 -82 129 l3 60 -42 3 c-41 3
-42 4 -58 55 -24 74 -91 196 -120 219 -28 22 -32 50 -10 68 31 26 18 64 -37
111 -58 49 -122 89 -142 89 -7 0 -28 -10 -47 -23 l-34 -23 -65 22 c-63 20 -65
22 -68 57 -2 19 -10 41 -18 48 -9 8 -57 14 -122 17 -119 5 -137 -3 -144 -63
-3 -26 -9 -31 -66 -47 l-62 -19 -27 26 c-38 35 -74 32 -147 -12 -94 -56 -96
-59 -96 -122 -1 -74 -15 -93 -72 -90 -54 3 -59 0 -106 -64 -46 -62 -52 -76
-61 -144 -7 -51 -7 -52 26 -70 18 -9 33 -19 33 -21 0 -2 -9 -35 -21 -73 -18
-60 -26 -71 -53 -83 -55 -23 -61 -37 -46 -119 24 -133 24 -144 0 -174 -74 -93
-173 -235 -200 -284 -25 -47 -30 -68 -30 -122 0 -59 3 -69 27 -92 16 -15 45
-35 66 -46 21 -11 40 -28 43 -37 3 -9 12 -31 21 -49 13 -27 14 -37 3 -62 -15
-38 -6 -67 24 -75 23 -6 24 -10 28 -118 4 -138 25 -191 97 -243 66 -49 144
-65 306 -65 l135 0 0 -126 c0 -119 -1 -125 -19 -119 -21 6 -19 14 -97 -355
-47 -221 -52 -277 -28 -287 16 -6 97 1 319 27 220 26 482 49 513 45 21 -2 91
-9 157 -15 66 -6 201 -21 300 -33 202 -23 231 -25 247 -9 8 8 3 55 -21 174
-18 90 -39 197 -47 238 -8 41 -22 105 -30 143 -15 64 -18 67 -45 67 l-29 0 0
134 c0 127 1 134 23 149 12 8 42 33 66 56 34 31 50 39 68 35 13 -4 30 -1 38 6
11 9 32 11 69 6 30 -3 74 -3 98 0 39 5 46 11 60 43 38 86 104 116 161 71 14
-11 28 -20 32 -20 21 0 225 190 225 210 0 6 -9 29 -21 51 -14 28 -18 50 -14
70 7 32 50 89 67 89 5 0 23 9 39 21 l29 20 0 137 c0 153 -8 181 -55 197 -45
15 -54 23 -70 63 -14 33 -14 40 7 100 l23 63 -100 95 c-55 52 -111 98 -124
101 -14 3 -35 -1 -51 -11 -16 -9 -42 -16 -59 -16 -26 0 -36 9 -71 59 -22 33
-40 64 -40 70 0 5 20 17 45 26 72 28 81 44 66 116 -16 80 -8 89 75 89 56 0 68
4 95 28 23 21 32 39 36 72 5 44 4 46 -46 88 -28 24 -51 52 -51 62 0 11 23 42
50 69 56 56 63 85 30 138 -23 38 -66 52 -137 46 -30 -3 -53 -1 -57 5 -4 6 -1
42 5 79 13 75 20 64 -71 123 -25 16 -53 30 -64 30 -10 0 -40 -22 -66 -50 -39
-41 -54 -50 -83 -50 -28 0 -43 9 -83 50 -27 28 -56 50 -65 50 -8 0 -35 -12
-60 -28z m83 -129 c38 -37 40 -38 121 -39 l82 -1 37 39 c54 56 68 51 68 -22 0
-109 37 -147 146 -152 l69 -3 -52 -49 c-51 -48 -53 -52 -53 -103 0 -56 5 -64
70 -115 19 -15 32 -29 29 -32 -3 -3 -36 -8 -72 -11 -76 -5 -97 -16 -122 -58
-14 -24 -16 -43 -11 -97 8 -86 -5 -93 -58 -33 l-38 43 -92 0 -92 0 -39 -40
c-21 -22 -45 -40 -52 -40 -16 0 -17 32 -3 80 9 31 6 40 -24 86 l-35 52 -70 4
c-38 2 -74 7 -78 12 -8 7 16 30 71 69 23 16 26 25 26 77 0 58 -1 59 -50 102
-27 24 -50 46 -50 51 0 4 29 7 64 7 83 0 91 4 128 57 28 42 30 48 19 83 -24
81 -1 93 61 33z m-957 -243 c12 -37 33 -51 105 -71 25 -7 71 -26 104 -43 55
-29 59 -30 70 -13 30 49 29 49 66 19 34 -29 34 -29 17 -55 -23 -35 -22 -40 16
-78 46 -47 101 -144 133 -236 32 -93 50 -116 80 -109 17 5 23 0 28 -17 12 -45
7 -56 -33 -68 -38 -11 -39 -12 -59 -96 -29 -115 -89 -236 -151 -303 -28 -30
-51 -57 -51 -60 0 -4 7 -15 15 -26 21 -27 19 -39 -10 -58 -24 -16 -27 -15 -54
5 l-30 22 -48 -20 c-47 -20 -85 -30 -191 -54 -58 -12 -82 -36 -82 -82 0 -27
-2 -28 -42 -25 -43 3 -43 3 -46 44 -4 52 -20 66 -102 88 -36 10 -88 31 -116
47 -61 34 -71 35 -99 9 l-21 -20 -24 25 c-20 21 -21 28 -11 53 14 34 4 67 -29
97 -24 21 -74 124 -85 173 -9 43 -38 66 -74 59 -25 -5 -31 -2 -42 24 -13 33
-3 49 32 49 28 0 37 22 53 125 8 55 21 115 29 134 19 44 12 67 -24 80 -33 12
-36 26 -10 60 17 22 21 23 51 12 37 -13 34 -14 127 76 50 49 53 55 53 102 0
46 3 52 30 66 29 15 31 15 39 -8 13 -32 37 -40 71 -23 16 7 70 24 121 37 90
22 92 23 107 61 14 35 19 39 45 36 25 -2 33 -10 42 -38z m1193 -739 c23 -55
63 -83 140 -96 33 -5 52 -2 88 15 l46 23 46 -46 45 -45 -26 -32 c-31 -37 -32
-46 -11 -97 61 -144 74 -165 114 -181 l40 -17 0 -66 c0 -62 -2 -67 -23 -73
-49 -12 -105 -96 -138 -204 -11 -38 -10 -43 15 -73 l27 -32 -47 -48 -47 -48
-38 25 c-46 29 -90 30 -144 5 -47 -22 -79 -55 -92 -96 -9 -29 -13 -30 -71 -33
l-61 -3 -10 39 c-13 48 -34 68 -100 93 -64 24 -89 24 -121 -1 -34 -27 -45 -25
-101 15 l-48 36 25 37 c33 47 28 76 -28 190 -38 76 -47 88 -73 92 -27 5 -30 9
-33 45 -6 64 6 98 40 120 35 22 50 46 92 149 33 77 29 118 -12 124 -29 4 -28
16 3 36 14 9 34 34 45 56 l20 40 40 -21 c95 -50 238 -1 254 87 l7 34 58 0 58
0 21 -49z m-1922 -218 c3 -10 10 -25 15 -33 35 -55 38 -75 21 -124 l-17 -47
65 -62 c116 -111 142 -123 187 -87 22 17 28 18 56 6 99 -42 107 -49 119 -93
16 -66 33 -73 171 -73 l118 0 23 53 c23 50 26 53 77 66 30 8 60 16 66 18 7 3
21 -9 30 -26 26 -45 55 -40 156 28 l87 60 0 -69 c0 -47 6 -78 17 -99 20 -34
57 -54 84 -46 14 5 19 1 19 -14 0 -11 5 -31 11 -45 10 -20 8 -33 -10 -70 -11
-25 -21 -49 -21 -53 0 -9 -106 -109 -198 -184 l-72 -61 -101 89 c-125 109
-123 107 -142 100 -23 -9 -48 -52 -41 -70 3 -9 45 -51 92 -93 48 -43 91 -83
95 -90 8 -15 8 -15 -96 -101 -82 -68 -101 -99 -84 -134 19 -37 57 -36 100 3
40 37 114 101 166 144 19 16 73 63 120 105 47 42 97 84 110 95 13 10 44 36 68
57 46 39 55 39 88 2 6 -7 35 -30 65 -53 l54 -41 22 20 c33 31 94 36 118 10 14
-15 17 -26 10 -40 -8 -18 -107 -101 -149 -126 -15 -9 -16 -32 -15 -212 1 -199
0 -202 -22 -217 -13 -9 -66 -52 -118 -96 -214 -179 -305 -252 -332 -266 -33
-17 -16 -28 -179 105 -98 80 -135 111 -220 185 -20 17 -60 51 -88 75 l-51 43
0 183 c0 157 -2 184 -16 196 -13 10 -66 15 -203 19 -173 5 -189 7 -235 30 -75
37 -85 58 -90 175 -3 90 -37 247 -63 287 -3 6 -7 24 -8 40 -3 37 -38 74 -95
102 -45 22 -45 22 -43 70 3 41 11 58 60 122 32 42 72 96 90 122 72 105 94 132
109 132 8 0 17 -8 20 -17z m1314 -43 c0 -17 -27 -77 -38 -84 -19 -12 -19 32 0
63 20 31 38 41 38 21z m-846 -1553 c47 -41 68 -59 116 -97 76 -59 81 -64 134
-111 28 -26 62 -56 76 -67 l25 -20 -45 -6 c-112 -14 -234 -26 -338 -32 l-113
-7 5 24 c3 13 10 53 16 89 18 104 40 212 51 248 12 36 9 37 73 -21z m1135
-148 c18 -99 31 -182 28 -185 -4 -4 -214 12 -267 20 -8 2 -49 6 -91 10 -42 5
-81 11 -88 15 -10 7 174 163 314 268 24 17 46 37 50 42 3 6 9 11 14 11 4 0 22
-81 40 -181z"/>
<path d="M3180 3892 c-81 -36 -130 -127 -110 -204 22 -78 100 -138 182 -138
38 0 99 23 97 38 -1 20 -64 55 -102 57 -28 2 -46 9 -59 25 -32 39 -33 67 -4
105 25 32 31 35 81 35 34 0 55 5 58 13 2 6 7 10 10 7 4 -3 0 -18 -7 -32 -8
-15 -10 -31 -5 -39 5 -8 7 -21 4 -29 -11 -41 -14 -91 -5 -85 5 3 8 0 5 -7 -3
-7 5 -19 17 -27 20 -12 24 -11 45 15 61 77 27 223 -62 260 -35 14 -118 18
-145 6z m167 -244 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z"/>
<path d="M1913 3682 c-82 -29 -123 -49 -160 -79 -113 -96 -169 -183 -194 -301
-23 -109 -23 -165 0 -273 28 -135 83 -219 211 -320 117 -93 318 -126 476 -79
38 12 80 26 94 33 70 33 200 160 236 229 95 184 77 449 -42 605 -51 67 -159
149 -230 176 -159 59 -238 61 -391 9z m288 -83 c111 -35 229 -128 283 -223 92
-161 65 -364 -68 -518 -22 -26 -45 -48 -50 -48 -6 0 -19 -9 -30 -19 -29 -27
-114 -59 -192 -71 -105 -17 -201 9 -326 88 -63 39 -137 156 -164 257 -57 213
91 459 319 531 52 16 182 18 228 3z"/>
<path d="M2057 3373 c-19 -5 -44 -51 -102 -185 -21 -49 -41 -88 -45 -88 -8 0
-17 25 -65 169 -26 78 -57 107 -98 92 -22 -9 -27 -17 -27 -46 0 -19 9 -61 19
-92 10 -32 36 -111 56 -175 44 -141 69 -182 111 -186 38 -4 45 4 88 105 48
113 88 193 96 193 4 0 14 -17 23 -37 52 -125 101 -230 114 -245 9 -10 28 -18
43 -18 50 0 68 35 159 312 22 70 41 135 41 145 0 28 -20 43 -56 43 -35 0 -50
-14 -64 -57 -5 -15 -24 -71 -43 -123 l-35 -94 -35 74 c-19 41 -44 97 -56 125
-37 83 -65 103 -124 88z"/>
<path d="M3185 2891 c-118 -33 -200 -113 -243 -235 -20 -59 -23 -82 -18 -138
11 -117 71 -219 171 -288 80 -55 247 -65 338 -21 68 33 142 105 173 169 36 75
45 204 20 280 -40 119 -140 208 -263 236 -87 19 -102 19 -178 -3z m200 -112
c167 -88 205 -287 78 -410 -65 -63 -104 -81 -177 -82 -69 0 -129 25 -184 77
-133 124 -85 345 90 421 51 22 146 19 193 -6z"/>
</g>
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Torch Choice
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference Torch-Choice
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Torch Choice" class="md-nav__button md-logo" aria-label="Torch Choice" data-md-component="logo">
      
  
  <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="500.000000pt" height="500.000000pt" viewBox="0 0 500.000000 500.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,500.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M3039 4192 c-24 -15 -53 -32 -64 -38 -16 -9 -19 -19 -15 -55 2 -24 4
-60 4 -79 l1 -35 -83 -3 c-81 -3 -83 -3 -102 -35 -23 -38 -35 -87 -23 -96 4
-3 30 -32 56 -63 47 -55 48 -57 28 -70 -12 -7 -21 -20 -21 -28 0 -8 -18 -28
-40 -43 -45 -32 -47 -43 -21 -106 22 -53 34 -59 127 -60 86 -1 87 -4 78 -105
l-6 -71 62 -33 c35 -17 69 -32 77 -32 8 0 38 23 67 50 66 62 92 65 150 13 22
-20 43 -40 44 -45 2 -4 -38 -8 -88 -8 -106 0 -151 -19 -174 -73 -7 -18 -25
-38 -39 -46 -23 -12 -34 -11 -93 5 -78 22 -87 37 -82 129 l3 60 -42 3 c-41 3
-42 4 -58 55 -24 74 -91 196 -120 219 -28 22 -32 50 -10 68 31 26 18 64 -37
111 -58 49 -122 89 -142 89 -7 0 -28 -10 -47 -23 l-34 -23 -65 22 c-63 20 -65
22 -68 57 -2 19 -10 41 -18 48 -9 8 -57 14 -122 17 -119 5 -137 -3 -144 -63
-3 -26 -9 -31 -66 -47 l-62 -19 -27 26 c-38 35 -74 32 -147 -12 -94 -56 -96
-59 -96 -122 -1 -74 -15 -93 -72 -90 -54 3 -59 0 -106 -64 -46 -62 -52 -76
-61 -144 -7 -51 -7 -52 26 -70 18 -9 33 -19 33 -21 0 -2 -9 -35 -21 -73 -18
-60 -26 -71 -53 -83 -55 -23 -61 -37 -46 -119 24 -133 24 -144 0 -174 -74 -93
-173 -235 -200 -284 -25 -47 -30 -68 -30 -122 0 -59 3 -69 27 -92 16 -15 45
-35 66 -46 21 -11 40 -28 43 -37 3 -9 12 -31 21 -49 13 -27 14 -37 3 -62 -15
-38 -6 -67 24 -75 23 -6 24 -10 28 -118 4 -138 25 -191 97 -243 66 -49 144
-65 306 -65 l135 0 0 -126 c0 -119 -1 -125 -19 -119 -21 6 -19 14 -97 -355
-47 -221 -52 -277 -28 -287 16 -6 97 1 319 27 220 26 482 49 513 45 21 -2 91
-9 157 -15 66 -6 201 -21 300 -33 202 -23 231 -25 247 -9 8 8 3 55 -21 174
-18 90 -39 197 -47 238 -8 41 -22 105 -30 143 -15 64 -18 67 -45 67 l-29 0 0
134 c0 127 1 134 23 149 12 8 42 33 66 56 34 31 50 39 68 35 13 -4 30 -1 38 6
11 9 32 11 69 6 30 -3 74 -3 98 0 39 5 46 11 60 43 38 86 104 116 161 71 14
-11 28 -20 32 -20 21 0 225 190 225 210 0 6 -9 29 -21 51 -14 28 -18 50 -14
70 7 32 50 89 67 89 5 0 23 9 39 21 l29 20 0 137 c0 153 -8 181 -55 197 -45
15 -54 23 -70 63 -14 33 -14 40 7 100 l23 63 -100 95 c-55 52 -111 98 -124
101 -14 3 -35 -1 -51 -11 -16 -9 -42 -16 -59 -16 -26 0 -36 9 -71 59 -22 33
-40 64 -40 70 0 5 20 17 45 26 72 28 81 44 66 116 -16 80 -8 89 75 89 56 0 68
4 95 28 23 21 32 39 36 72 5 44 4 46 -46 88 -28 24 -51 52 -51 62 0 11 23 42
50 69 56 56 63 85 30 138 -23 38 -66 52 -137 46 -30 -3 -53 -1 -57 5 -4 6 -1
42 5 79 13 75 20 64 -71 123 -25 16 -53 30 -64 30 -10 0 -40 -22 -66 -50 -39
-41 -54 -50 -83 -50 -28 0 -43 9 -83 50 -27 28 -56 50 -65 50 -8 0 -35 -12
-60 -28z m83 -129 c38 -37 40 -38 121 -39 l82 -1 37 39 c54 56 68 51 68 -22 0
-109 37 -147 146 -152 l69 -3 -52 -49 c-51 -48 -53 -52 -53 -103 0 -56 5 -64
70 -115 19 -15 32 -29 29 -32 -3 -3 -36 -8 -72 -11 -76 -5 -97 -16 -122 -58
-14 -24 -16 -43 -11 -97 8 -86 -5 -93 -58 -33 l-38 43 -92 0 -92 0 -39 -40
c-21 -22 -45 -40 -52 -40 -16 0 -17 32 -3 80 9 31 6 40 -24 86 l-35 52 -70 4
c-38 2 -74 7 -78 12 -8 7 16 30 71 69 23 16 26 25 26 77 0 58 -1 59 -50 102
-27 24 -50 46 -50 51 0 4 29 7 64 7 83 0 91 4 128 57 28 42 30 48 19 83 -24
81 -1 93 61 33z m-957 -243 c12 -37 33 -51 105 -71 25 -7 71 -26 104 -43 55
-29 59 -30 70 -13 30 49 29 49 66 19 34 -29 34 -29 17 -55 -23 -35 -22 -40 16
-78 46 -47 101 -144 133 -236 32 -93 50 -116 80 -109 17 5 23 0 28 -17 12 -45
7 -56 -33 -68 -38 -11 -39 -12 -59 -96 -29 -115 -89 -236 -151 -303 -28 -30
-51 -57 -51 -60 0 -4 7 -15 15 -26 21 -27 19 -39 -10 -58 -24 -16 -27 -15 -54
5 l-30 22 -48 -20 c-47 -20 -85 -30 -191 -54 -58 -12 -82 -36 -82 -82 0 -27
-2 -28 -42 -25 -43 3 -43 3 -46 44 -4 52 -20 66 -102 88 -36 10 -88 31 -116
47 -61 34 -71 35 -99 9 l-21 -20 -24 25 c-20 21 -21 28 -11 53 14 34 4 67 -29
97 -24 21 -74 124 -85 173 -9 43 -38 66 -74 59 -25 -5 -31 -2 -42 24 -13 33
-3 49 32 49 28 0 37 22 53 125 8 55 21 115 29 134 19 44 12 67 -24 80 -33 12
-36 26 -10 60 17 22 21 23 51 12 37 -13 34 -14 127 76 50 49 53 55 53 102 0
46 3 52 30 66 29 15 31 15 39 -8 13 -32 37 -40 71 -23 16 7 70 24 121 37 90
22 92 23 107 61 14 35 19 39 45 36 25 -2 33 -10 42 -38z m1193 -739 c23 -55
63 -83 140 -96 33 -5 52 -2 88 15 l46 23 46 -46 45 -45 -26 -32 c-31 -37 -32
-46 -11 -97 61 -144 74 -165 114 -181 l40 -17 0 -66 c0 -62 -2 -67 -23 -73
-49 -12 -105 -96 -138 -204 -11 -38 -10 -43 15 -73 l27 -32 -47 -48 -47 -48
-38 25 c-46 29 -90 30 -144 5 -47 -22 -79 -55 -92 -96 -9 -29 -13 -30 -71 -33
l-61 -3 -10 39 c-13 48 -34 68 -100 93 -64 24 -89 24 -121 -1 -34 -27 -45 -25
-101 15 l-48 36 25 37 c33 47 28 76 -28 190 -38 76 -47 88 -73 92 -27 5 -30 9
-33 45 -6 64 6 98 40 120 35 22 50 46 92 149 33 77 29 118 -12 124 -29 4 -28
16 3 36 14 9 34 34 45 56 l20 40 40 -21 c95 -50 238 -1 254 87 l7 34 58 0 58
0 21 -49z m-1922 -218 c3 -10 10 -25 15 -33 35 -55 38 -75 21 -124 l-17 -47
65 -62 c116 -111 142 -123 187 -87 22 17 28 18 56 6 99 -42 107 -49 119 -93
16 -66 33 -73 171 -73 l118 0 23 53 c23 50 26 53 77 66 30 8 60 16 66 18 7 3
21 -9 30 -26 26 -45 55 -40 156 28 l87 60 0 -69 c0 -47 6 -78 17 -99 20 -34
57 -54 84 -46 14 5 19 1 19 -14 0 -11 5 -31 11 -45 10 -20 8 -33 -10 -70 -11
-25 -21 -49 -21 -53 0 -9 -106 -109 -198 -184 l-72 -61 -101 89 c-125 109
-123 107 -142 100 -23 -9 -48 -52 -41 -70 3 -9 45 -51 92 -93 48 -43 91 -83
95 -90 8 -15 8 -15 -96 -101 -82 -68 -101 -99 -84 -134 19 -37 57 -36 100 3
40 37 114 101 166 144 19 16 73 63 120 105 47 42 97 84 110 95 13 10 44 36 68
57 46 39 55 39 88 2 6 -7 35 -30 65 -53 l54 -41 22 20 c33 31 94 36 118 10 14
-15 17 -26 10 -40 -8 -18 -107 -101 -149 -126 -15 -9 -16 -32 -15 -212 1 -199
0 -202 -22 -217 -13 -9 -66 -52 -118 -96 -214 -179 -305 -252 -332 -266 -33
-17 -16 -28 -179 105 -98 80 -135 111 -220 185 -20 17 -60 51 -88 75 l-51 43
0 183 c0 157 -2 184 -16 196 -13 10 -66 15 -203 19 -173 5 -189 7 -235 30 -75
37 -85 58 -90 175 -3 90 -37 247 -63 287 -3 6 -7 24 -8 40 -3 37 -38 74 -95
102 -45 22 -45 22 -43 70 3 41 11 58 60 122 32 42 72 96 90 122 72 105 94 132
109 132 8 0 17 -8 20 -17z m1314 -43 c0 -17 -27 -77 -38 -84 -19 -12 -19 32 0
63 20 31 38 41 38 21z m-846 -1553 c47 -41 68 -59 116 -97 76 -59 81 -64 134
-111 28 -26 62 -56 76 -67 l25 -20 -45 -6 c-112 -14 -234 -26 -338 -32 l-113
-7 5 24 c3 13 10 53 16 89 18 104 40 212 51 248 12 36 9 37 73 -21z m1135
-148 c18 -99 31 -182 28 -185 -4 -4 -214 12 -267 20 -8 2 -49 6 -91 10 -42 5
-81 11 -88 15 -10 7 174 163 314 268 24 17 46 37 50 42 3 6 9 11 14 11 4 0 22
-81 40 -181z"/>
<path d="M3180 3892 c-81 -36 -130 -127 -110 -204 22 -78 100 -138 182 -138
38 0 99 23 97 38 -1 20 -64 55 -102 57 -28 2 -46 9 -59 25 -32 39 -33 67 -4
105 25 32 31 35 81 35 34 0 55 5 58 13 2 6 7 10 10 7 4 -3 0 -18 -7 -32 -8
-15 -10 -31 -5 -39 5 -8 7 -21 4 -29 -11 -41 -14 -91 -5 -85 5 3 8 0 5 -7 -3
-7 5 -19 17 -27 20 -12 24 -11 45 15 61 77 27 223 -62 260 -35 14 -118 18
-145 6z m167 -244 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z"/>
<path d="M1913 3682 c-82 -29 -123 -49 -160 -79 -113 -96 -169 -183 -194 -301
-23 -109 -23 -165 0 -273 28 -135 83 -219 211 -320 117 -93 318 -126 476 -79
38 12 80 26 94 33 70 33 200 160 236 229 95 184 77 449 -42 605 -51 67 -159
149 -230 176 -159 59 -238 61 -391 9z m288 -83 c111 -35 229 -128 283 -223 92
-161 65 -364 -68 -518 -22 -26 -45 -48 -50 -48 -6 0 -19 -9 -30 -19 -29 -27
-114 -59 -192 -71 -105 -17 -201 9 -326 88 -63 39 -137 156 -164 257 -57 213
91 459 319 531 52 16 182 18 228 3z"/>
<path d="M2057 3373 c-19 -5 -44 -51 -102 -185 -21 -49 -41 -88 -45 -88 -8 0
-17 25 -65 169 -26 78 -57 107 -98 92 -22 -9 -27 -17 -27 -46 0 -19 9 -61 19
-92 10 -32 36 -111 56 -175 44 -141 69 -182 111 -186 38 -4 45 4 88 105 48
113 88 193 96 193 4 0 14 -17 23 -37 52 -125 101 -230 114 -245 9 -10 28 -18
43 -18 50 0 68 35 159 312 22 70 41 135 41 145 0 28 -20 43 -56 43 -35 0 -50
-14 -64 -57 -5 -15 -24 -71 -43 -123 l-35 -94 -35 74 c-19 41 -44 97 -56 125
-37 83 -65 103 -124 88z"/>
<path d="M3185 2891 c-118 -33 -200 -113 -243 -235 -20 -59 -23 -82 -18 -138
11 -117 71 -219 171 -288 80 -55 247 -65 338 -21 68 33 142 105 173 169 36 75
45 204 20 280 -40 119 -140 208 -263 236 -87 19 -102 19 -178 -3z m200 -112
c167 -88 205 -287 78 -410 -65 -63 -104 -81 -177 -82 -69 0 -129 25 -184 77
-133 124 -85 345 90 421 51 22 146 19 193 -6z"/>
</g>
</svg>

    </a>
    Torch Choice
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data_management/" class="md-nav__link">
        Data Management
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../easy_data_management/" class="md-nav__link">
        Easy Data Management and Stata Users
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../conditional_logit_model_mode_canada/" class="md-nav__link">
        Conditional Logit Model
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nested_logit_model_house_cooling/" class="md-nav__link">
        Nested Logit Model
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../post_estimation_demos/" class="md-nav__link">
        Post Estimation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../coefficient_initialization/" class="md-nav__link">
        Coefficient Initialization
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projects/" class="md-nav__link">
        Related Projects
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../test/" class="md-nav__link">
        Compatibility Tests
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          API Reference Torch-Choice
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        API Reference Torch-Choice
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.ChoiceDataset" class="md-nav__link">
    torch_choice.data.ChoiceDataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.num_items" class="md-nav__link">
    num_items
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.num_sessions" class="md-nav__link">
    num_sessions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.num_users" class="md-nav__link">
    num_users
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.x_dict" class="md-nav__link">
    x_dict
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.apply_tensor" class="md-nav__link">
    apply_tensor()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.clone" class="md-nav__link">
    clone()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.summary" class="md-nav__link">
    summary()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.to" class="md-nav__link">
    to()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.JointDataset" class="md-nav__link">
    torch_choice.data.JointDataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.item_index" class="md-nav__link">
    item_index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.clone" class="md-nav__link">
    clone()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.to" class="md-nav__link">
    to()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.ConditionalLogitModel" class="md-nav__link">
    torch_choice.model.ConditionalLogitModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.num_params" class="md-nav__link">
    num_params
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.get_coefficient" class="md-nav__link">
    get_coefficient()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.loss" class="md-nav__link">
    loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.negative_log_likelihood" class="md-nav__link">
    negative_log_likelihood()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.summary" class="md-nav__link">
    summary()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.NestedLogitModel" class="md-nav__link">
    torch_choice.model.NestedLogitModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.num_params" class="md-nav__link">
    num_params
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.forward" class="md-nav__link">
    forward()
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.forward--todo-the-conditionallogitmodel-returns-predicted-utility-the-nestedlogitmodel-behaves-the-same" class="md-nav__link">
    TODO: the ConditionalLogitModel returns predicted utility, the NestedLogitModel behaves the same?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.get_coefficient" class="md-nav__link">
    get_coefficient()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.log_likelihood" class="md-nav__link">
    log_likelihood()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.loss" class="md-nav__link">
    loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.negative_log_likelihood" class="md-nav__link">
    negative_log_likelihood()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.ChoiceDataset" class="md-nav__link">
    torch_choice.data.ChoiceDataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.num_items" class="md-nav__link">
    num_items
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.num_sessions" class="md-nav__link">
    num_sessions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.num_users" class="md-nav__link">
    num_users
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.x_dict" class="md-nav__link">
    x_dict
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__eq__" class="md-nav__link">
    __eq__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.apply_tensor" class="md-nav__link">
    apply_tensor()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.clone" class="md-nav__link">
    clone()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.summary" class="md-nav__link">
    summary()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.choice_dataset.ChoiceDataset.to" class="md-nav__link">
    to()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.JointDataset" class="md-nav__link">
    torch_choice.data.JointDataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.item_index" class="md-nav__link">
    item_index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__getitem__" class="md-nav__link">
    __getitem__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__len__" class="md-nav__link">
    __len__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.clone" class="md-nav__link">
    clone()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.data.joint_dataset.JointDataset.to" class="md-nav__link">
    to()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.ConditionalLogitModel" class="md-nav__link">
    torch_choice.model.ConditionalLogitModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.num_params" class="md-nav__link">
    num_params
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.get_coefficient" class="md-nav__link">
    get_coefficient()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.loss" class="md-nav__link">
    loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.negative_log_likelihood" class="md-nav__link">
    negative_log_likelihood()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.conditional_logit_model.ConditionalLogitModel.summary" class="md-nav__link">
    summary()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.NestedLogitModel" class="md-nav__link">
    torch_choice.model.NestedLogitModel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.device" class="md-nav__link">
    device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.num_params" class="md-nav__link">
    num_params
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.forward" class="md-nav__link">
    forward()
  </a>
  
    <nav class="md-nav" aria-label="forward()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.forward--todo-the-conditionallogitmodel-returns-predicted-utility-the-nestedlogitmodel-behaves-the-same" class="md-nav__link">
    TODO: the ConditionalLogitModel returns predicted utility, the NestedLogitModel behaves the same?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.get_coefficient" class="md-nav__link">
    get_coefficient()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.log_likelihood" class="md-nav__link">
    log_likelihood()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.loss" class="md-nav__link">
    loss()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#torch_choice.model.nested_logit_model.NestedLogitModel.negative_log_likelihood" class="md-nav__link">
    negative_log_likelihood()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="api-reference-torch-choice">API Reference: Torch Choice</h1>


<div class="doc doc-object doc-class">


<a id="torch_choice.data.ChoiceDataset"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code>torch.<span title="torch.utils">utils</span>.<span title="torch.utils.data">data</span>.<span title="torch.utils.data.Dataset">Dataset</span></code></p>



        <details class="quote">
          <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="k">class</span> <span class="nc">ChoiceDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>                 <span class="n">item_index</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>                 <span class="n">num_items</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>                 <span class="n">num_users</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>                 <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>                 <span class="n">user_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>                 <span class="n">session_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>                 <span class="n">item_availability</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        Initialization methods for the dataset object, researchers should supply all information about the dataset</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        using this initialization method.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        The number of choice instances are called `batch_size` in the documentation. The `batch_size` corresponds to the</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        file length in wide-format dataset, and often denoted using `N`. We call it `batch_size` to follow the convention</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        in machine learning literature.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        A `choice instance` is a row of the dataset, so there are `batch_size` choice instances in each `ChoiceDataset`.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        The dataset consists of:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        (1) a collection of `batch_size` tuples (item_id, user_id, session_id, label), where each tuple is a choice instance.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        (2) a collection of `observables` associated with item, user, session, etc.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">            item_index (torch.LongTensor): a tensor of shape (batch_size) indicating the relevant item in each row</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">                of the dataset, the relevant item can be:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">                (1) the item bought in this choice instance,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">                (2) or the item reviewed by the user. In the later case, we need the `label` tensor to specify the rating score.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">                NOTE: The support for second case is under-development, currently, we are only supporting binary label.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            num_items (Optional[int]): the number of items in the dataset. If `None` is provided (default), the number of items will be inferred from the number of unique numbers in `item_index`.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">            num_users (Optional[int]): the number of users in the dataset. If `None` is provided (default), the number of users will be inferred from the number of unique numbers in `user_index`.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            label (Optional[torch.LongTensor], optional): a tensor of shape (batch_size) indicating the label for prediction in</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">                each choice instance. While you want to predict the item bought, you can leave the `label` argument</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">                as `None` in the initialization method, and the model will use `item_index` as the object to be predicted.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">                But if you are, for example, predicting the rating an user gave an item, label must be provided.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            user_index (Optional[torch.LongTensor], optional): a tensor of shape num_purchases (batch_size) indicating</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">                the ID of the user who was involved in each choice instance. If `None` user index is provided, it&#39;s assumed</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">                that the choice instances are from the same user.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">                `user_index` is required if and only if there are multiple users in the dataset, for example:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">                    (1) user-observables is involved in the utility form,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">                    (2) and/or the coefficient is user-specific.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">                This tensor is used to select the corresponding user observables and coefficients assigned to the</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">                user (like theta_user) for making prediction for that purchase.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">            session_index (Optional[torch.LongTensor], optional): a tensor of shape num_purchases (batch_size) indicating</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">                the ID of the session when that choice instance occurred. This tensor is used to select the correct</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">                session observables or price observables for making prediction for that choice instance. Therefore, if</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">                there is no session/price observables, you can leave this argument as `None`. In this case, the `ChoiceDataset`</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">                object will assume each choice instance to be in its own session.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            item_availability (Optional[torch.BoolTensor], optional): A boolean tensor of shape (num_sessions, num_items)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">                indicating the availability of each item in each session. Utilities of unavailable items would be set to -infinite,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">                and hence these unavailable items will be set to 0 while making prediction.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">                We assume all items are available if set to None.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        Other Kwargs (Observables):</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">            One can specify the following types of observables, where * in shape denotes any positive</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">                integer. Typically * represents the number of observables.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            Please refer to the documentation for a detailed guide to use observables.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            1. user observables must start with &#39;user_&#39; and have shape (num_users, *)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            2. item observables must start with &#39;item_&#39; and have shape (num_items, *)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            3. session observables must start with &#39;session_&#39; and have shape (num_sessions, *)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">            4. taste observables (those vary by user and item) must start with `taste_` and have shape</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">                (num_users, num_items, *).</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            NOTE: we don&#39;t recommend using taste observables, because num_users * num_items is potentially large.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            5. price observables (those vary by session and item) must start with `price_` and have</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">                shape (num_sessions, num_items, *)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            6. itemsession observables starting with `itemsession_`, this is a more intuitive alias to the price</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">                observable.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="c1"># ENHANCEMENT(Tianyu): add item_names for summary.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ChoiceDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">item_index</span> <span class="o">=</span> <span class="n">item_index</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_num_items</span> <span class="o">=</span> <span class="n">num_items</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_num_users</span> <span class="o">=</span> <span class="n">num_users</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="o">=</span> <span class="n">user_index</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="o">=</span> <span class="n">session_index</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="c1"># if any([x.startswith(&#39;session_&#39;) or x.startswith(&#39;price_&#39;) for x in kwargs.keys()]):</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="c1"># if any session sensitive observable is provided, but session index is not,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="c1"># infer each row in the dataset to be a session.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="c1"># TODO: (design choice) should we assign unique session index to each choice instance or the same session index.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No `session_index` is provided, assume each choice instance is in its own session.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">item_availability</span> <span class="o">=</span> <span class="n">item_availability</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="c1"># all observable should be float.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="c1"># TODO: add a validation procedure to check the consistency of the dataset.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="sd">&quot;&quot;&quot;Retrieves samples corresponding to the provided index or list of indices.</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            indices (Union[int, torch.LongTensor]): a single integer index or a tensor of indices.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">            ChoiceDataset: a subset of the dataset.</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="c1"># convert single integer index to an array of indices.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">indices</span><span class="p">])</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">new_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;item_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="c1"># copy optional attributes.</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;user_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;session_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="c1"># item_availability has shape (num_sessions, num_items), no need to re-index it.</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;item_availability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_availability</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="c1"># copy other attributes.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">new_dict</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="sd">&quot;&quot;&quot;Returns number of samples in this dataset.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">            int: length of the dataset.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="sd">&quot;&quot;&quot;Returns whether all tensor attributes of both ChoiceDatasets are equal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ChoiceDataset</span><span class="p">):</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;You can only compare with ChoiceDataset objects.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="c1"># ignore NaNs while comparing.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">{}</span><span class="s1"> is not equal.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                        <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="k">return</span> <span class="n">flag</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="sd">&quot;&quot;&quot;Returns the device of the dataset.</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">            str: the device of the dataset.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="k">return</span> <span class="n">attr</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="k">def</span> <span class="nf">num_users</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="sd">&quot;&quot;&quot;Returns number of users involved in this dataset, returns 1 if there is no user identity.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="sd">            int: the number of users involved in this dataset.</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_users</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_users</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="c1"># infer from the number of unique items in  user_index.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">))</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="k">return</span> <span class="mi">1</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="c1"># for key, val in self.__dict__.items():</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="c1">#     if torch.is_tensor(val):</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="c1">#         if self._is_user_attribute(key) or self._is_taste_attribute(key):</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="c1">#             return val.shape[0]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="c1"># return 1</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="k">def</span> <span class="nf">num_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="sd">&quot;&quot;&quot;Returns the number of items involved in this dataset.</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">            int: the number of items involved in this dataset.</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="c1"># return the _num_items provided in the constructor.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_items</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="c1"># infer the number of items from item_index.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">))</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="c1"># for key, val in self.__dict__.items():</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="c1">#     if torch.is_tensor(val):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="c1">#         if self._is_item_attribute(key):</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="c1">#             return val.shape[0]</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="c1">#         elif self._is_taste_attribute(key) or self._is_price_attribute(key):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="c1">#             return val.shape[1]</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="c1"># return 1</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">def</span> <span class="nf">num_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="sd">&quot;&quot;&quot;Returns the number of sessions involved in this dataset.</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">            int: the number of sessions involved in this dataset.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_index</span><span class="p">))</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="c1"># if self.session_index is None:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="c1">#     return 1</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="c1"># for key, val in self.__dict__.items():</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="c1">#     if torch.is_tensor(val):</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="c1">#         if self._is_session_attribute(key) or self._is_price_attribute(key):</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="c1">#             return val.shape[0]</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="c1"># return 1</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="k">def</span> <span class="nf">x_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="sd">&quot;&quot;&quot;Formats attributes of in this dataset into shape (num_sessions, num_items, num_params) and returns in a dictionary format.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        Models in this package are expecting this dictionary based data format.</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">            Dict[object, torch.Tensor]: a dictionary with attribute names in the dataset as keys, and reshaped attribute</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">                tensors as values.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>  <span class="c1"># only include attributes.</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_tensor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>  <span class="c1"># reshape to (num_sessions, num_items, num_params).</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="k">return</span> <span class="n">out</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="sd">&quot;&quot;&quot;Creates an instance of ChoiceDataset from a dictionary of arguments.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">            dictionary (Dict[str, torch.tensor]): a dictionary with keys as argument names and values as arguments.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">            ChoiceDataset: the created copy of dataset.</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">dictionary</span><span class="p">)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="k">return</span> <span class="n">dataset</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">def</span> <span class="nf">apply_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="sd">&quot;&quot;&quot;This s a helper method to apply the provided function to all tensors and tensor values of all dictionaries.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">            func (callable): a callable function to be applied on tensors and tensor-values of dictionaries.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">            ChoiceDataset: the modified dataset.</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="c1"># boardcast func to dictionary of tensors as well.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                <span class="k">for</span> <span class="n">obj_key</span><span class="p">,</span> <span class="n">obj_item</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">obj_item</span><span class="p">):</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                        <span class="nb">setattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">obj_key</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">obj_item</span><span class="p">))</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="sd">&quot;&quot;&quot;Moves all tensors in this dataset to the specified PyTorch device.</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">            device (Union[str, torch.device]): the destination device.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">            ChoiceDataset: the modified dataset on the new device.</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_tensor</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="sd">&quot;&quot;&quot;Creates a copy of self.</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">            ChoiceDataset: a copy of self.</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                <span class="n">dictionary</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                <span class="n">dictionary</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="k">def</span> <span class="nf">_check_device_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="sd">&quot;&quot;&quot;Checks if all tensors in this dataset are on the same device.</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">            Exception: an exception is raised if not all tensors are on the same device.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="c1"># assert all tensors are on the same device.</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">devices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="n">devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">devices</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found tensors on different devices: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                            <span class="s1">&#39;Use dataset.to() method to align devices.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">def</span> <span class="nf">_size_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="sd">&quot;&quot;&quot;A helper method to get the string-representation of object sizes, this is helpful while constructing the</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        string representation of the dataset.</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">            value (object): an object to examine its size.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">            List[int]: list of integers representing the size of the object, length of the list is equal to dimension of `value`.</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="k">return</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="k">return</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="sd">&quot;&quot;&quot;A method to get a string representation of the dataset.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">            str: the string representation of the dataset.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="c1"># don&#39;t print shapes of internal attributes like _num_users and _num_items.</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_size_repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="si">}</span><span class="s2">, device=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="c1"># ==================================================================================================================</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="c1"># methods for checking attribute categories.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="c1"># ==================================================================================================================</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="k">def</span> <span class="nf">_is_item_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;item_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;item_availability&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;item_index&#39;</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="k">def</span> <span class="nf">_is_user_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;user_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;user_index&#39;</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="k">def</span> <span class="nf">_is_useritem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;useritem_&#39;</span><span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>    <span class="k">def</span> <span class="nf">_is_session_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;session_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;session_index&#39;</span><span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="k">def</span> <span class="nf">_is_price_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;price_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;itemsession_&#39;</span><span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">def</span> <span class="nf">_is_usersessionitem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;usersessionitem_&#39;</span><span class="p">)</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="k">def</span> <span class="nf">_is_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_item_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> \
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_user_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> \
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_useritem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> \
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_session_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> \
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_price_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> \
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_usersessionitem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="k">def</span> <span class="nf">_expand_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="sd">&quot;&quot;&quot;Expands attribute tensor to (len(self), num_items, num_params) shape for prediction tasks, this method</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">        won&#39;t reshape the tensor at all if the `key` (i.e., name of the tensor) suggests its not an attribute of any kind.</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">            key (str): name of the attribute used to determine the raw shape of the tensor. For example, &#39;item_obs&#39; means</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">                the raw tensor is in shape (num_items, num_params).</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">            val (torch.Tensor): the attribute tensor to be reshaped.</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">            torch.Tensor: the reshaped tensor with shape (num_sessions, num_items, num_params).</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="c1"># this is a sanity check.</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: the input key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> is not an attribute of the dataset, will NOT modify the provided tensor.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="n">num_params</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># the number of parameters/coefficients/observables.</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="c1"># convert attribute tensors to (len(self), num_items, num_params) shape.</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_user_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="c1"># user_attribute (num_users, *)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_item_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="c1"># item_attribute (num_items, *)</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_useritem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="c1"># useritem_attribute (num_users, num_items, *)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_session_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="c1"># session_attribute (num_sessions, *)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="c1"># elif self._is_taste_attribute(key):</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="c1">#     # taste_attribute (num_users, num_items, *)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="c1">#     out = val[self.user_index, :, :]</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_price_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="c1"># price_attribute (num_sessions, num_items, *)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_usersessionitem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>            <span class="c1"># usersessionitem_attribute has shape (num_users, num_sessions, num_items, *)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># (len(self), num_items, *)</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: the input key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> is not an attribute of the dataset, will NOT modify the provided tensor.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="n">num_params</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="k">return</span> <span class="n">out</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="k">def</span> <span class="nf">unique</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="n">arr</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="n">count_sort_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">counts</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="n">unique</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="n">count_sort_ind</span><span class="p">]</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">count_sort_ind</span><span class="p">]</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="k">return</span> <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="sd">&quot;&quot;&quot;A method to summarize the dataset.</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">            str: the string representation of the dataset.</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="n">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ChoiceDataset with </span><span class="si">{}</span><span class="s1"> sessions, </span><span class="si">{}</span><span class="s1"> items, </span><span class="si">{}</span><span class="s1"> users, </span><span class="si">{}</span><span class="s1"> purchase records (observations) .&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))]</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="c1"># summarize users.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>            <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">)</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The most frequent user is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> observations; the least frequent user is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> observations; on average, there are </span><span class="si">{</span><span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> observations per user.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="n">K</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> most frequent users are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>            <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> least frequent users are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="c1"># summarize items.</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="n">K</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The most frequent item is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, it was chosen </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> times; the least frequent item is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> it was </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> times; on average, each item was purchased </span><span class="si">{</span><span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> times.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> most frequent items are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> least frequent items are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Attribute Summaries:&#39;</span><span class="p">)</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Observable Tensor &#39;</span><span class="si">{}</span><span class="s2">&#39; with shape </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                <span class="c1"># price attributes are 3-dimensional tensors, ignore  for cleanness here.</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_price_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_usersessionitem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_useritem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)):</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">describe</span><span class="p">()))</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">device=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.device" class="doc doc-heading">
<code class="highlight language-python"><span class="n">device</span><span class="p">:</span> <span class="nb">str</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the device of the dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>the device of the dataset.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.num_items" class="doc doc-heading">
<code class="highlight language-python"><span class="n">num_items</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the number of items involved in this dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>int</code>
          </td>
          <td><p>the number of items involved in this dataset.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.num_sessions" class="doc doc-heading">
<code class="highlight language-python"><span class="n">num_sessions</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the number of sessions involved in this dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>int</code>
          </td>
          <td><p>the number of sessions involved in this dataset.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.num_users" class="doc doc-heading">
<code class="highlight language-python"><span class="n">num_users</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns number of users involved in this dataset, returns 1 if there is no user identity.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>int</code>
          </td>
          <td><p>the number of users involved in this dataset.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.x_dict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">x_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Formats attributes of in this dataset into shape (num_sessions, num_items, num_params) and returns in a dictionary format.
Models in this package are expecting this dictionary based data format.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[object, torch.<span title="torch.Tensor">Tensor</span>]</code>
          </td>
          <td><p>Dict[object, torch.Tensor]: a dictionary with attribute names in the dataset as keys, and reshaped attribute
tensors as values.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>



<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.__eq__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns whether all tensor attributes of both ChoiceDatasets are equal.</p>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="sd">&quot;&quot;&quot;Returns whether all tensor attributes of both ChoiceDatasets are equal.&quot;&quot;&quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ChoiceDataset</span><span class="p">):</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;You can only compare with ChoiceDataset objects.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="c1"># ignore NaNs while comparing.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">{}</span><span class="s1"> is not equal.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="k">return</span> <span class="n">flag</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.__getitem__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrieves samples corresponding to the provided index or list of indices.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>indices</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[int, torch.<span title="torch.LongTensor">LongTensor</span>]</code>
          </td>
          <td><p>a single integer index or a tensor of indices.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>ChoiceDataset</code></td>          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>a subset of the dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="sd">&quot;&quot;&quot;Retrieves samples corresponding to the provided index or list of indices.</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        indices (Union[int, torch.LongTensor]): a single integer index or a tensor of indices.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        ChoiceDataset: a subset of the dataset.</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="c1"># convert single integer index to an array of indices.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="n">indices</span><span class="p">])</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="n">new_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;item_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="c1"># copy optional attributes.</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;user_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;session_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="c1"># item_availability has shape (num_sessions, num_items), no need to re-index it.</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;item_availability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_availability</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="c1"># copy other attributes.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">new_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">item_index</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_availability</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Initialization methods for the dataset object, researchers should supply all information about the dataset
using this initialization method.</p>
<p>The number of choice instances are called <code>batch_size</code> in the documentation. The <code>batch_size</code> corresponds to the
file length in wide-format dataset, and often denoted using <code>N</code>. We call it <code>batch_size</code> to follow the convention
in machine learning literature.
A <code>choice instance</code> is a row of the dataset, so there are <code>batch_size</code> choice instances in each <code>ChoiceDataset</code>.</p>
<p>The dataset consists of:
(1) a collection of <code>batch_size</code> tuples (item_id, user_id, session_id, label), where each tuple is a choice instance.
(2) a collection of <code>observables</code> associated with item, user, session, etc.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>item_index</code></td>
          <td>
                <code>torch.<span title="torch.LongTensor">LongTensor</span></code>
          </td>
          <td><p>a tensor of shape (batch_size) indicating the relevant item in each row
of the dataset, the relevant item can be:
(1) the item bought in this choice instance,
(2) or the item reviewed by the user. In the later case, we need the <code>label</code> tensor to specify the rating score.
NOTE: The support for second case is under-development, currently, we are only supporting binary label.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_items</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>the number of items in the dataset. If <code>None</code> is provided (default), the number of items will be inferred from the number of unique numbers in <code>item_index</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_users</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>the number of users in the dataset. If <code>None</code> is provided (default), the number of users will be inferred from the number of unique numbers in <code>user_index</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>label</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.LongTensor">LongTensor</span>]</code>
          </td>
          <td><p>a tensor of shape (batch_size) indicating the label for prediction in
each choice instance. While you want to predict the item bought, you can leave the <code>label</code> argument
as <code>None</code> in the initialization method, and the model will use <code>item_index</code> as the object to be predicted.
But if you are, for example, predicting the rating an user gave an item, label must be provided.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>user_index</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.LongTensor">LongTensor</span>]</code>
          </td>
          <td><p>a tensor of shape num_purchases (batch_size) indicating
the ID of the user who was involved in each choice instance. If <code>None</code> user index is provided, it's assumed
that the choice instances are from the same user.
<code>user_index</code> is required if and only if there are multiple users in the dataset, for example:
    (1) user-observables is involved in the utility form,
    (2) and/or the coefficient is user-specific.
This tensor is used to select the corresponding user observables and coefficients assigned to the
user (like theta_user) for making prediction for that purchase.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>session_index</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.LongTensor">LongTensor</span>]</code>
          </td>
          <td><p>a tensor of shape num_purchases (batch_size) indicating
the ID of the session when that choice instance occurred. This tensor is used to select the correct
session observables or price observables for making prediction for that choice instance. Therefore, if
there is no session/price observables, you can leave this argument as <code>None</code>. In this case, the <code>ChoiceDataset</code>
object will assume each choice instance to be in its own session.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>item_availability</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[torch.<span title="torch.BoolTensor">BoolTensor</span>]</code>
          </td>
          <td><p>A boolean tensor of shape (num_sessions, num_items)
indicating the availability of each item in each session. Utilities of unavailable items would be set to -infinite,
and hence these unavailable items will be set to 0 while making prediction.
We assume all items are available if set to None.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Other Kwargs (Observables):
    One can specify the following types of observables, where * in shape denotes any positive
        integer. Typically * represents the number of observables.
    Please refer to the documentation for a detailed guide to use observables.
    1. user observables must start with 'user_' and have shape (num_users, <em>)
    2. item observables must start with 'item_' and have shape (num_items, </em>)
    3. session observables must start with 'session_' and have shape (num_sessions, <em>)
    4. taste observables (those vary by user and item) must start with <code>taste_</code> and have shape
        (num_users, num_items, </em>).
    NOTE: we don't recommend using taste observables, because num_users * num_items is potentially large.
    5. price observables (those vary by session and item) must start with <code>price_</code> and have
        shape (num_sessions, num_items, *)
    6. itemsession observables starting with <code>itemsession_</code>, this is a more intuitive alias to the price
        observable.</p>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>             <span class="n">item_index</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>             <span class="n">num_items</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>             <span class="n">num_users</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>             <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>             <span class="n">user_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>             <span class="n">session_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>             <span class="n">item_availability</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Initialization methods for the dataset object, researchers should supply all information about the dataset</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    using this initialization method.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    The number of choice instances are called `batch_size` in the documentation. The `batch_size` corresponds to the</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    file length in wide-format dataset, and often denoted using `N`. We call it `batch_size` to follow the convention</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    in machine learning literature.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    A `choice instance` is a row of the dataset, so there are `batch_size` choice instances in each `ChoiceDataset`.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    The dataset consists of:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    (1) a collection of `batch_size` tuples (item_id, user_id, session_id, label), where each tuple is a choice instance.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    (2) a collection of `observables` associated with item, user, session, etc.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        item_index (torch.LongTensor): a tensor of shape (batch_size) indicating the relevant item in each row</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">            of the dataset, the relevant item can be:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">            (1) the item bought in this choice instance,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">            (2) or the item reviewed by the user. In the later case, we need the `label` tensor to specify the rating score.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            NOTE: The support for second case is under-development, currently, we are only supporting binary label.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        num_items (Optional[int]): the number of items in the dataset. If `None` is provided (default), the number of items will be inferred from the number of unique numbers in `item_index`.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        num_users (Optional[int]): the number of users in the dataset. If `None` is provided (default), the number of users will be inferred from the number of unique numbers in `user_index`.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        label (Optional[torch.LongTensor], optional): a tensor of shape (batch_size) indicating the label for prediction in</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">            each choice instance. While you want to predict the item bought, you can leave the `label` argument</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">            as `None` in the initialization method, and the model will use `item_index` as the object to be predicted.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">            But if you are, for example, predicting the rating an user gave an item, label must be provided.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        user_index (Optional[torch.LongTensor], optional): a tensor of shape num_purchases (batch_size) indicating</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            the ID of the user who was involved in each choice instance. If `None` user index is provided, it&#39;s assumed</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            that the choice instances are from the same user.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            `user_index` is required if and only if there are multiple users in the dataset, for example:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">                (1) user-observables is involved in the utility form,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">                (2) and/or the coefficient is user-specific.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            This tensor is used to select the corresponding user observables and coefficients assigned to the</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            user (like theta_user) for making prediction for that purchase.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        session_index (Optional[torch.LongTensor], optional): a tensor of shape num_purchases (batch_size) indicating</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            the ID of the session when that choice instance occurred. This tensor is used to select the correct</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">            session observables or price observables for making prediction for that choice instance. Therefore, if</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            there is no session/price observables, you can leave this argument as `None`. In this case, the `ChoiceDataset`</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">            object will assume each choice instance to be in its own session.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        item_availability (Optional[torch.BoolTensor], optional): A boolean tensor of shape (num_sessions, num_items)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">            indicating the availability of each item in each session. Utilities of unavailable items would be set to -infinite,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            and hence these unavailable items will be set to 0 while making prediction.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            We assume all items are available if set to None.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    Other Kwargs (Observables):</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        One can specify the following types of observables, where * in shape denotes any positive</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">            integer. Typically * represents the number of observables.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        Please refer to the documentation for a detailed guide to use observables.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        1. user observables must start with &#39;user_&#39; and have shape (num_users, *)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        2. item observables must start with &#39;item_&#39; and have shape (num_items, *)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        3. session observables must start with &#39;session_&#39; and have shape (num_sessions, *)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        4. taste observables (those vary by user and item) must start with `taste_` and have shape</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            (num_users, num_items, *).</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        NOTE: we don&#39;t recommend using taste observables, because num_users * num_items is potentially large.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        5. price observables (those vary by session and item) must start with `price_` and have</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            shape (num_sessions, num_items, *)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        6. itemsession observables starting with `itemsession_`, this is a more intuitive alias to the price</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">            observable.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="c1"># ENHANCEMENT(Tianyu): add item_names for summary.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">ChoiceDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">item_index</span> <span class="o">=</span> <span class="n">item_index</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_num_items</span> <span class="o">=</span> <span class="n">num_items</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_num_users</span> <span class="o">=</span> <span class="n">num_users</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="o">=</span> <span class="n">user_index</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="o">=</span> <span class="n">session_index</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="c1"># if any([x.startswith(&#39;session_&#39;) or x.startswith(&#39;price_&#39;) for x in kwargs.keys()]):</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="c1"># if any session sensitive observable is provided, but session index is not,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="c1"># infer each row in the dataset to be a session.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="c1"># TODO: (design choice) should we assign unique session index to each choice instance or the same session index.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No `session_index` is provided, assume each choice instance is in its own session.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">item_availability</span> <span class="o">=</span> <span class="n">item_availability</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="c1"># all observable should be float.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.__len__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns number of samples in this dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>int</code>
          </td>
          <td><p>length of the dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="sd">&quot;&quot;&quot;Returns number of samples in this dataset.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        int: length of the dataset.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>A method to get a string representation of the dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>the string representation of the dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>    <span class="sd">&quot;&quot;&quot;A method to get a string representation of the dataset.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">        str: the string representation of the dataset.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="c1"># don&#39;t print shapes of internal attributes like _num_users and _num_items.</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_size_repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="si">}</span><span class="s2">, device=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.apply_tensor" class="doc doc-heading">
<code class="highlight language-python"><span class="n">apply_tensor</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This s a helper method to apply the provided function to all tensors and tensor values of all dictionaries.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>func</code></td>
          <td>
                <code>callable</code>
          </td>
          <td><p>a callable function to be applied on tensors and tensor-values of dictionaries.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>ChoiceDataset</code></td>          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>the modified dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="k">def</span> <span class="nf">apply_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="sd">&quot;&quot;&quot;This s a helper method to apply the provided function to all tensors and tensor values of all dictionaries.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        func (callable): a callable function to be applied on tensors and tensor-values of dictionaries.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">        ChoiceDataset: the modified dataset.</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="c1"># boardcast func to dictionary of tensors as well.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="k">for</span> <span class="n">obj_key</span><span class="p">,</span> <span class="n">obj_item</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">obj_item</span><span class="p">):</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                    <span class="nb">setattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">obj_key</span><span class="p">,</span> <span class="n">func</span><span class="p">(</span><span class="n">obj_item</span><span class="p">))</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.clone" class="doc doc-heading">
<code class="highlight language-python"><span class="n">clone</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Creates a copy of self.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>ChoiceDataset</code></td>          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>a copy of self.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="sd">&quot;&quot;&quot;Creates a copy of self.</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        ChoiceDataset: a copy of self.</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="n">dictionary</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="n">dictionary</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.summary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">summary</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>A method to summarize the dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>None</code>
          </td>
          <td><p>the string representation of the dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="sd">&quot;&quot;&quot;A method to summarize the dataset.</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a><span class="sd">        str: the string representation of the dataset.</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="n">summary</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ChoiceDataset with </span><span class="si">{}</span><span class="s1"> sessions, </span><span class="si">{}</span><span class="s1"> items, </span><span class="si">{}</span><span class="s1"> users, </span><span class="si">{}</span><span class="s1"> purchase records (observations) .&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_sessions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))]</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="c1"># summarize users.</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_index</span><span class="p">)</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The most frequent user is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> observations; the least frequent user is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> observations; on average, there are </span><span class="si">{</span><span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> observations per user.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="n">K</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> most frequent users are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> least frequent users are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>    <span class="c1"># summarize items.</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span><span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="n">K</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The most frequent item is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, it was chosen </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> times; the least frequent item is </span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> it was </span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> times; on average, each item was purchased </span><span class="si">{</span><span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> times.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>    <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> most frequent items are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1"> least frequent items are: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unique</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> times)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Attribute Summaries:&#39;</span><span class="p">)</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Observable Tensor &#39;</span><span class="si">{}</span><span class="s2">&#39; with shape </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>            <span class="c1"># price attributes are 3-dimensional tensors, ignore  for cleanness here.</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_price_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_usersessionitem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_useritem_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">)):</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">describe</span><span class="p">()))</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">device=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.choice_dataset.ChoiceDataset.to" class="doc doc-heading">
<code class="highlight language-python"><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Moves all tensors in this dataset to the specified PyTorch device.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>device</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, torch.<span title="torch.device">device</span>]</code>
          </td>
          <td><p>the destination device.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>ChoiceDataset</code></td>          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>the modified dataset on the new device.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/choice_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-299" name="__codelineno-0-299"></a><span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;ChoiceDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="sd">&quot;&quot;&quot;Moves all tensors in this dataset to the specified PyTorch device.</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        device (Union[str, torch.device]): the destination device.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        ChoiceDataset: the modified dataset on the new device.</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_tensor</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">


<a id="torch_choice.data.JointDataset"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code>torch.<span title="torch.utils">utils</span>.<span title="torch.utils.data">data</span>.<span title="torch.utils.data.Dataset">Dataset</span></code></p>

  
      <p>A helper class for joining several pytorch datasets, using JointDataset
and pytorch data loader allows for sampling the same batch index from several
datasets.</p>
<p>The JointDataset class is a wrapper for the torch.utils.data.ChoiceDataset class, it is particularly useful when we
need to make prediction from multiple datasets. For example, you have data on consumer purchase records in a fast food
store, and suppose every customer will purchase exactly a single main food and a single drink. In this case, you have
two separate datasets: FoodDataset and DrinkDataset. You may want to use PyTorch sampler to sample them in a dependent
manner: you want to take the i-th sample from both datasets, so that you know what (food, drink) combo the i-th customer
purchased. You can do this by using the JointDataset class.</p>


        <details class="quote">
          <summary>Source code in <code>torch_choice/data/joint_dataset.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">class</span> <span class="nc">JointDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="sd">&quot;&quot;&quot;A helper class for joining several pytorch datasets, using JointDataset</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    and pytorch data loader allows for sampling the same batch index from several</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    datasets.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    The JointDataset class is a wrapper for the torch.utils.data.ChoiceDataset class, it is particularly useful when we</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    need to make prediction from multiple datasets. For example, you have data on consumer purchase records in a fast food</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    store, and suppose every customer will purchase exactly a single main food and a single drink. In this case, you have</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    two separate datasets: FoodDataset and DrinkDataset. You may want to use PyTorch sampler to sample them in a dependent</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    manner: you want to take the i-th sample from both datasets, so that you know what (food, drink) combo the i-th customer</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    purchased. You can do this by using the JointDataset class.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">datasets</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="sd">&quot;&quot;&quot;The initialize methods.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            Arbitrarily many datasets with arbitrary names as keys. In the example above, you can construct</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ```</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            dataset = JointDataset(food=FoodDataset, drink=DrinkDataset)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            ```</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            All datasets should have the same length.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">JointDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="c1"># check the length of sub-datasets are the same.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="sd">&quot;&quot;&quot;Get the number of samples in the joint dataset.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            int: the number of samples in the joint dataset, which is the same as the number of samples in each dataset contained.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChoiceDataset</span><span class="p">]:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="sd">&quot;&quot;&quot;Queries samples from the dataset by index.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            indices (Union[int, torch.LongTensor]): an integer or a 1D tensor of multiple indices.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            Dict[str, ChoiceDataset]: the subset of the dataset. Keys of the dictionary will be names of each dataset</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">                contained (the same as the keys of the ``datasets`` argument in the constructor). Values will be subsets</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">                of contained datasets, sliced using the provided indices.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="sd">&quot;&quot;&quot;A method to get a string representation of the dataset.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            str: the string representation of the dataset.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;JointDataset with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s1"> sub-datasets: (&#39;</span><span class="p">]</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="sd">&quot;&quot;&quot;Returns the device of datasets contained in the joint dataset.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            str: the device of the dataset.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;JointDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="sd">&quot;&quot;&quot;Moves all datasets in this dataset to the specified PyTorch device.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            device (Union[str, torch.device]): the destination device.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">            ChoiceDataset: the modified dataset on the new device.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;JointDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="sd">&quot;&quot;&quot;Returns a copy of the dataset.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">            JointDataset: a copy of the dataset.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">return</span> <span class="n">JointDataset</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="k">def</span> <span class="nf">item_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="sd">&quot;&quot;&quot;Returns the current index of each dataset.</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">            torch.LongTensor: the indices of items chosen.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item_index</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.data.joint_dataset.JointDataset.device" class="doc doc-heading">
<code class="highlight language-python"><span class="n">device</span><span class="p">:</span> <span class="nb">str</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the device of datasets contained in the joint dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>the device of the dataset.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.data.joint_dataset.JointDataset.item_index" class="doc doc-heading">
<code class="highlight language-python"><span class="n">item_index</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the current index of each dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.LongTensor">LongTensor</span></code>
          </td>
          <td><p>torch.LongTensor: the indices of items chosen.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>



<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.joint_dataset.JointDataset.__getitem__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Queries samples from the dataset by index.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>indices</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[int, torch.<span title="torch.LongTensor">LongTensor</span>]</code>
          </td>
          <td><p>an integer or a 1D tensor of multiple indices.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a>]</code>
          </td>
          <td><p>Dict[str, ChoiceDataset]: the subset of the dataset. Keys of the dictionary will be names of each dataset
contained (the same as the keys of the <code>datasets</code> argument in the constructor). Values will be subsets
of contained datasets, sliced using the provided indices.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/joint_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ChoiceDataset</span><span class="p">]:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="sd">&quot;&quot;&quot;Queries samples from the dataset by index.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        indices (Union[int, torch.LongTensor]): an integer or a 1D tensor of multiple indices.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        Dict[str, ChoiceDataset]: the subset of the dataset. Keys of the dictionary will be names of each dataset</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            contained (the same as the keys of the ``datasets`` argument in the constructor). Values will be subsets</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">            of contained datasets, sliced using the provided indices.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.joint_dataset.JointDataset.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">datasets</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The initialize methods.</p>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/joint_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">datasets</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="sd">&quot;&quot;&quot;The initialize methods.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Arbitrarily many datasets with arbitrary names as keys. In the example above, you can construct</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ```</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        dataset = JointDataset(food=FoodDataset, drink=DrinkDataset)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        ```</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        All datasets should have the same length.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">JointDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="c1"># check the length of sub-datasets are the same.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.joint_dataset.JointDataset.__len__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Get the number of samples in the joint dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>int</code>
          </td>
          <td><p>the number of samples in the joint dataset, which is the same as the number of samples in each dataset contained.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/joint_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="sd">&quot;&quot;&quot;Get the number of samples in the joint dataset.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        int: the number of samples in the joint dataset, which is the same as the number of samples in each dataset contained.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.joint_dataset.JointDataset.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>A method to get a string representation of the dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>the string representation of the dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/joint_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="sd">&quot;&quot;&quot;A method to get a string representation of the dataset.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        str: the string representation of the dataset.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;JointDataset with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span><span class="si">}</span><span class="s1"> sub-datasets: (&#39;</span><span class="p">]</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.joint_dataset.JointDataset.clone" class="doc doc-heading">
<code class="highlight language-python"><span class="n">clone</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns a copy of the dataset.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>JointDataset</code></td>          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.joint_dataset.JointDataset" href="#torch_choice.data.JointDataset">JointDataset</a></code>
          </td>
          <td><p>a copy of the dataset.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/joint_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;JointDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="sd">&quot;&quot;&quot;Returns a copy of the dataset.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        JointDataset: a copy of the dataset.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">return</span> <span class="n">JointDataset</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.data.joint_dataset.JointDataset.to" class="doc doc-heading">
<code class="highlight language-python"><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Moves all datasets in this dataset to the specified PyTorch device.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>device</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[str, torch.<span title="torch.device">device</span>]</code>
          </td>
          <td><p>the destination device.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>ChoiceDataset</code></td>          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.joint_dataset.JointDataset" href="#torch_choice.data.JointDataset">JointDataset</a></code>
          </td>
          <td><p>the modified dataset on the new device.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/data/joint_dataset.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;JointDataset&quot;</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="sd">&quot;&quot;&quot;Moves all datasets in this dataset to the specified PyTorch device.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        device (Union[str, torch.device]): the destination device.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        ChoiceDataset: the modified dataset on the new device.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">


<a id="torch_choice.model.ConditionalLogitModel"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code><span title="torch.nn">nn</span>.<span title="torch.nn.Module">Module</span></code></p>

  
      <p>The more generalized version of conditional logit model, the model allows for research specific
variable types(groups) and different levels of variations for coefficient.</p>
<p>The model allows for the following levels for variable variations:</p>

<details class="note">
  <summary>unless the <code>-full</code> flag is specified (which means we want to explicitly model coefficients</summary>
  <p>for all items), for all variation levels related to item (item specific and user-item specific),
the model force coefficients for the first item to be zero. This design follows standard
econometric practice.</p>
</details>      <ul>
<li>
<p>constant: constant over all users and items,</p>
</li>
<li>
<p>user: user-specific parameters but constant across all items,</p>
</li>
<li>
<p>item: item-specific parameters but constant across all users, parameters for the first item are
    forced to be zero.</p>
</li>
<li>
<p>item-full: item-specific parameters but constant across all users, explicitly model for all items.</p>
</li>
<li>
<p>user-item: parameters that are specific to both user and item, parameter for the first item
    for all users are forced to be zero.</p>
</li>
<li>user-item-full: parameters that are specific to both user and item, explicitly model for all items.</li>
</ul>


        <details class="quote">
          <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">class</span> <span class="nc">ConditionalLogitModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="sd">&quot;&quot;&quot;The more generalized version of conditional logit model, the model allows for research specific</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    variable types(groups) and different levels of variations for coefficient.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    The model allows for the following levels for variable variations:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    NOTE: unless the `-full` flag is specified (which means we want to explicitly model coefficients</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        for all items), for all variation levels related to item (item specific and user-item specific),</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        the model force coefficients for the first item to be zero. This design follows standard</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        econometric practice.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    - constant: constant over all users and items,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    - user: user-specific parameters but constant across all items,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    - item: item-specific parameters but constant across all users, parameters for the first item are</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        forced to be zero.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    - item-full: item-specific parameters but constant across all users, explicitly model for all items.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    - user-item: parameters that are specific to both user and item, parameter for the first item</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        for all users are forced to be zero.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">    - user-item-full: parameters that are specific to both user and item, explicitly model for all items.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                 <span class="n">formula</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                 <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChoiceDataset</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                 <span class="n">coef_variation_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                 <span class="n">num_param_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                 <span class="n">num_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                 <span class="n">num_users</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                 <span class="n">regularization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                 <span class="n">regularization_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                 <span class="n">weight_initialization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            formula (str): a string representing the utility formula.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">                The formula consists of &#39;(variable_name|variation)&#39;s separated by &#39;+&#39;, for example:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">                &quot;(var1|item) + (var2|user) + (var3|constant)&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">                where the first part of each term is the name of the variable</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">                and the second part is the variation of the coefficient.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">                The variation can be one of the following:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">                &#39;constant&#39;, &#39;item&#39;, &#39;item-full&#39;, &#39;user&#39;, &#39;user-item&#39;, &#39;user-item-full&#39;.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">                All spaces in the formula will be ignored, hence please do not use spaces in variable/observable names.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            data (ChoiceDataset): a ChoiceDataset object for training the model, the parser will infer dimensions of variables</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">                and sizes of coefficients from the ChoiceDataset.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">            coef_variation_dict (Dict[str, str]): variable type to variation level dictionary. Keys of this dictionary</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">                should be variable names in the dataset (i.e., these starting with `itemsession_`, `price_`, `user_`, etc), or `intercept`</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">                if the researcher requires an intercept term.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">                For each variable name X_var (e.g., `user_income`) or `intercept`, the corresponding dictionary key should</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">                be one of the following values, this value specifies the &quot;level of variation&quot; of the coefficient.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">                - `constant`: the coefficient constant over all users and items: $X \beta$.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">                - `user`: user-specific parameters but constant across all items: $X \beta_{u}$.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">                - `item`: item-specific parameters but constant across all users, $X \beta_{i}$.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">                    Note that the coefficients for the first item are forced to be zero following the standard practice</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">                    in econometrics.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">                - `item-full`: the same configuration as `item`, but does not force the coefficients of the first item to</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">                    be zeros.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">                The following configurations are supported by the package, but we don&#39;t recommend using them due to the</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">                    large number of parameters.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">                - `user-item`: parameters that are specific to both user and item, parameter for the first item</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">                    for all users are forced to be zero.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">                - `user-item-full`: parameters that are specific to both user and item, explicitly model for all items.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            num_param_dict (Optional[Dict[str, int]]): variable type to number of parameters dictionary with keys exactly the same</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">                as the `coef_variation_dict`. Values of `num_param_dict` records numbers of features in each kind of variable.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">                If None is supplied, num_param_dict will be a dictionary with the same keys as the `coef_variation_dict` dictionary</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">                and values of all ones. Default to be None.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">            num_items (int): number of items in the dataset.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">            num_users (int): number of users in the dataset.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            regularization (Optional[str]): this argument takes values from {&#39;L1&#39;, &#39;L2&#39;, None}, which specifies the type of</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">                regularization added to the log-likelihood.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">                - &#39;L1&#39; will subtract regularization_weight * 1-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">                - &#39;L2&#39; will subtract regularization_weight * 2-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">                - None does not modify the log-likelihood.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">            regularization_weight (Optional[float]): the weight of parameter norm subtracted from the log-likelihood.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">                This term controls the strength of regularization. This argument is required if and only if regularization</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">                is not None.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">            weight_initialization (Optional[Union[str, Dict[str, str]]]): controls for how coefficients are initialized;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">                users can pass a string from {&#39;normal&#39;, &#39;uniform&#39;, &#39;zero&#39;} to initialize all coefficients in the same way.</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">                Alternatively, users can pass a dictionary with keys exactly the same as the `coef_variation_dict` dictionary,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">                and values from {&#39;normal&#39;, &#39;uniform&#39;, &#39;zero&#39;} to initialize coefficients of different types of variables differently.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">                By default, all coefficients are initialized following a standard normal distribution.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="c1"># Check that the model received a valid combination of inputs so that it can be initialized.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="n">coef_variation_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either coef_variation_dict or formula should be provided to specify the model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">coef_variation_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of coef_variation_dict or formula should be provided to specify the model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If formula is provided, data should be provided to specify the model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="c1"># Build necessary dictionaries for model initialization.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">if</span> <span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="c1"># Use dictionaries to initialize the model.</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="k">if</span> <span class="n">num_param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`num_param_dict` is not provided, all variables will be treated as having one parameter.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="n">num_param_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="mi">1</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="k">assert</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">num_param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="c1"># variable `var` with variation `spec` to variable `var[spec]`.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">rename</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># old variable name --&gt; new variable name.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">specificity</span> <span class="ow">in</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">rename</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">specificity</span><span class="si">}</span><span class="s2">]&quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="k">for</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">coef_variation_dict</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">num_param_dict</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_param_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="c1"># Use the formula to infer model.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="n">coef_variation_dict</span><span class="p">,</span> <span class="n">num_param_dict</span> <span class="o">=</span> <span class="n">parse_formula</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="c1"># Model Initialization.</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">ConditionalLogitModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">coef_variation_dict</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">num_param_dict</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">num_items</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">num_users</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">regularization</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Provided regularization=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s2"> is not allowed, allowed values are [&#39;L1&#39;, &#39;L2&#39;, None].&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">=</span> <span class="n">regularization_weight</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified regularization type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s1"> without providing regularization_weight.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified no regularization but you provide regularization_weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span><span class="si">}</span><span class="s1">, you should leave regularization_weight as None if you do not want to regularize the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="c1"># check number of parameters specified are all positive.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">num_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">assert</span> <span class="n">num_params</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;num_params needs to be positive, got: </span><span class="si">{</span><span class="n">num_params</span><span class="si">}</span><span class="s1">.&#39;</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="c1"># infer the number of parameters for intercept if the researcher forgets.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">` key found in coef_variation_dict but not in num_param_dict, num_param_dict[&#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&#39;] has been set to 1.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="c1"># inform coefficients their ways of being initialized.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">weight_initialization</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="c1"># construct trainable parameters.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">coef_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">variation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="k">if</span> <span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="c1"># use the variable-specific initialization if provided.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                    <span class="n">init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span><span class="p">[</span><span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                    <span class="c1"># use default initialization.</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                    <span class="n">init</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="c1"># initialize all coefficients in the same way.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="n">init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">coef_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">Coefficient</span><span class="p">(</span><span class="n">variation</span><span class="o">=</span><span class="n">variation</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                                              <span class="n">num_items</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                                              <span class="n">num_users</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                                              <span class="n">num_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">],</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                                              <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="c1"># A ModuleDict is required to properly register all trainable parameters.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="c1"># self.parameter() will fail if a python dictionary is used instead.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coef_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">coef_dict</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="sd">&quot;&quot;&quot;Return a string representation of the model.</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">            str: the string representation of the model.</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="n">out_str_lst</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Conditional logistic discrete choice model, expects input features:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">num_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">out_str_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X[</span><span class="si">{</span><span class="n">var_type</span><span class="si">}</span><span class="s1">] with </span><span class="si">{</span><span class="n">num_params</span><span class="si">}</span><span class="s1"> parameters, with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span><span class="si">}</span><span class="s1"> level variation.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_str_lst</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;device=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="k">def</span> <span class="nf">num_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="sd">&quot;&quot;&quot;Get the total number of parameters. For example, if there is only an user-specific coefficient to be multiplied</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        with the K-dimensional observable, then the total number of parameters would be K x number of users, assuming no</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        intercept is involved.</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">            int: the total number of learnable parameters.</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="sd">&quot;&quot;&quot;Print out the current model parameter.&quot;&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="k">if</span> <span class="n">coefficient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Variable Type: &#39;</span><span class="p">,</span> <span class="n">var_type</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">coef</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="n">manual_coef_value_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">        Forward pass of the model.</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">            batch: a `ChoiceDataset` object.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">            manual_coef_value_dict (Optional[Dict[str, torch.Tensor]], optional): a dictionary with</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">                keys in {&#39;u&#39;, &#39;i&#39;} etc and tensors as values. If provided, the model will force</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">                coefficient to be the provided values and compute utility conditioned on the provided</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">                coefficient values. This feature is useful when the research wishes to plug in particular</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">                values of coefficients and examine the utility values. If not provided, the model will</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">                use the learned coefficient values in self.coef_dict.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">            torch.Tensor: a tensor of shape (num_trips, num_items) whose (t, i) entry represents</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">                the utility from item i in trip t for the user involved in that trip.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="n">x_dict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">x_dict</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="c1"># intercept term has no input tensor from the ChoiceDataset data structure.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="c1"># the tensor for intercept has only 1 feature, every entry is 1.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="n">x_dict</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                <span class="k">break</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="c1"># compute the utility from each item in each choice session.</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">total_utility</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="c1"># for each type of variables, apply the corresponding coefficient to input x.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="c1"># variable type is named as &quot;observable_name[variation]&quot;, retrieve the corresponding observable name.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">corresponding_observable</span> <span class="o">=</span> <span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">total_utility</span> <span class="o">+=</span> <span class="n">coef</span><span class="p">(</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="n">x_dict</span><span class="p">[</span><span class="n">corresponding_observable</span><span class="p">],</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                <span class="n">batch</span><span class="o">.</span><span class="n">user_index</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="n">manual_coef_value</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">manual_coef_value_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">manual_coef_value_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">])</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="k">assert</span> <span class="n">total_utility</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">item_availability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="c1"># mask out unavailable items.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="n">total_utility</span><span class="p">[</span><span class="o">~</span><span class="n">batch</span><span class="o">.</span><span class="n">item_availability</span><span class="p">[</span><span class="n">batch</span><span class="o">.</span><span class="n">session_index</span><span class="p">,</span> <span class="p">:]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">total_utility</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="k">return</span> <span class="n">total_utility</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>    <span class="k">def</span> <span class="nf">negative_log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="sd">&quot;&quot;&quot;Computes the log-likelihood for the batch and label.</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        TODO: consider remove y, change to label.</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        TODO: consider move this method outside the model, the role of the model is to compute the utility.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">            batch (ChoiceDataset): a ChoiceDataset object containing the data.</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">            y (torch.Tensor): the label.</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">            is_train (bool, optional): whether to trace the gradient. Defaults to True.</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">            torch.Tensor: the negative log-likelihood.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="c1"># (num_trips, num_items)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="n">total_utility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="n">logP</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">total_utility</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span> <span class="n">logP</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="k">return</span> <span class="n">nll</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="sd">&quot;&quot;&quot;The loss function to be optimized. This is a wrapper of `negative_log_likelihood` + regularization loss if required.&quot;&quot;&quot;</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">nll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">L</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="p">]</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                <span class="n">nll</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">L</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="k">return</span> <span class="n">nll</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="sd">&quot;&quot;&quot;Returns the device of the coefficient.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">            torch.device: the device of the model.</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">def</span> <span class="nf">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="c1"># check if the given variable is an intercept (fixed effect) term.</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="c1"># intercept (fixed effect) terms are defined as &#39;intercept[*]&#39; and looks like &#39;intercept[user]&#39;, &#39;intercept[item]&#39;, etc.</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;intercept[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>    <span class="k">def</span> <span class="nf">get_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="sd">&quot;&quot;&quot;Retrieve the coefficient tensor for the given variable.</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">            variable (str): the variable name.</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">            torch.Tensor: the corresponding coefficient tensor of the requested variable.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;coef_dict.</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">.coef&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.device" class="doc doc-heading">
<code class="highlight language-python"><span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the device of the coefficient.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.device">device</span></code>
          </td>
          <td><p>torch.device: the device of the model.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.num_params" class="doc doc-heading">
<code class="highlight language-python"><span class="n">num_params</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Get the total number of parameters. For example, if there is only an user-specific coefficient to be multiplied
with the K-dimensional observable, then the total number of parameters would be K x number of users, assuming no
intercept is involved.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>int</code>
          </td>
          <td><p>the total number of learnable parameters.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>



<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coef_variation_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_param_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regularization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regularization_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>formula</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>a string representing the utility formula.
The formula consists of '(variable_name|variation)'s separated by '+', for example:
"(var1|item) + (var2|user) + (var3|constant)"
where the first part of each term is the name of the variable
and the second part is the variation of the coefficient.
The variation can be one of the following:
'constant', 'item', 'item-full', 'user', 'user-item', 'user-item-full'.
All spaces in the formula will be ignored, hence please do not use spaces in variable/observable names.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>data</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>a ChoiceDataset object for training the model, the parser will infer dimensions of variables
and sizes of coefficients from the ChoiceDataset.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>coef_variation_dict</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, str]</code>
          </td>
          <td><p>variable type to variation level dictionary. Keys of this dictionary
should be variable names in the dataset (i.e., these starting with <code>itemsession_</code>, <code>price_</code>, <code>user_</code>, etc), or <code>intercept</code>
if the researcher requires an intercept term.
For each variable name X_var (e.g., <code>user_income</code>) or <code>intercept</code>, the corresponding dictionary key should
be one of the following values, this value specifies the "level of variation" of the coefficient.</p>
<ul>
<li>
<p><code>constant</code>: the coefficient constant over all users and items: <span class="arithmatex">\(X eta\)</span>.</p>
</li>
<li>
<p><code>user</code>: user-specific parameters but constant across all items: <span class="arithmatex">\(X eta_{u}\)</span>.</p>
</li>
<li>
<p><code>item</code>: item-specific parameters but constant across all users, <span class="arithmatex">\(X eta_{i}\)</span>.
    Note that the coefficients for the first item are forced to be zero following the standard practice
    in econometrics.</p>
</li>
<li>
<p><code>item-full</code>: the same configuration as <code>item</code>, but does not force the coefficients of the first item to
    be zeros.</p>
</li>
</ul>
<p>The following configurations are supported by the package, but we don't recommend using them due to the
    large number of parameters.
- <code>user-item</code>: parameters that are specific to both user and item, parameter for the first item
    for all users are forced to be zero.</p>
<ul>
<li><code>user-item-full</code>: parameters that are specific to both user and item, explicitly model for all items.</li>
</ul></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_param_dict</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[str, int]]</code>
          </td>
          <td><p>variable type to number of parameters dictionary with keys exactly the same
as the <code>coef_variation_dict</code>. Values of <code>num_param_dict</code> records numbers of features in each kind of variable.
If None is supplied, num_param_dict will be a dictionary with the same keys as the <code>coef_variation_dict</code> dictionary
and values of all ones. Default to be None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_items</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of items in the dataset.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_users</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>number of users in the dataset.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>regularization</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td><p>this argument takes values from {'L1', 'L2', None}, which specifies the type of
regularization added to the log-likelihood.
- 'L1' will subtract regularization_weight * 1-norm of parameters from the log-likelihood.
- 'L2' will subtract regularization_weight * 2-norm of parameters from the log-likelihood.
- None does not modify the log-likelihood.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>regularization_weight</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>the weight of parameter norm subtracted from the log-likelihood.
This term controls the strength of regularization. This argument is required if and only if regularization
is not None.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>weight_initialization</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[str, <span title="typing.Dict">Dict</span>[str, str]]]</code>
          </td>
          <td><p>controls for how coefficients are initialized;
users can pass a string from {'normal', 'uniform', 'zero'} to initialize all coefficients in the same way.
Alternatively, users can pass a dictionary with keys exactly the same as the <code>coef_variation_dict</code> dictionary,
and values from {'normal', 'uniform', 'zero'} to initialize coefficients of different types of variables differently.
By default, all coefficients are initialized following a standard normal distribution.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>             <span class="n">formula</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>             <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChoiceDataset</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>             <span class="n">coef_variation_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>             <span class="n">num_param_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>             <span class="n">num_items</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>             <span class="n">num_users</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>             <span class="n">regularization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>             <span class="n">regularization_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>             <span class="n">weight_initialization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">        formula (str): a string representing the utility formula.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            The formula consists of &#39;(variable_name|variation)&#39;s separated by &#39;+&#39;, for example:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            &quot;(var1|item) + (var2|user) + (var3|constant)&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            where the first part of each term is the name of the variable</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            and the second part is the variation of the coefficient.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            The variation can be one of the following:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            &#39;constant&#39;, &#39;item&#39;, &#39;item-full&#39;, &#39;user&#39;, &#39;user-item&#39;, &#39;user-item-full&#39;.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            All spaces in the formula will be ignored, hence please do not use spaces in variable/observable names.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        data (ChoiceDataset): a ChoiceDataset object for training the model, the parser will infer dimensions of variables</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">            and sizes of coefficients from the ChoiceDataset.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        coef_variation_dict (Dict[str, str]): variable type to variation level dictionary. Keys of this dictionary</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">            should be variable names in the dataset (i.e., these starting with `itemsession_`, `price_`, `user_`, etc), or `intercept`</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            if the researcher requires an intercept term.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">            For each variable name X_var (e.g., `user_income`) or `intercept`, the corresponding dictionary key should</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            be one of the following values, this value specifies the &quot;level of variation&quot; of the coefficient.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            - `constant`: the coefficient constant over all users and items: $X \beta$.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            - `user`: user-specific parameters but constant across all items: $X \beta_{u}$.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            - `item`: item-specific parameters but constant across all users, $X \beta_{i}$.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">                Note that the coefficients for the first item are forced to be zero following the standard practice</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">                in econometrics.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            - `item-full`: the same configuration as `item`, but does not force the coefficients of the first item to</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">                be zeros.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            The following configurations are supported by the package, but we don&#39;t recommend using them due to the</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">                large number of parameters.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            - `user-item`: parameters that are specific to both user and item, parameter for the first item</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">                for all users are forced to be zero.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            - `user-item-full`: parameters that are specific to both user and item, explicitly model for all items.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        num_param_dict (Optional[Dict[str, int]]): variable type to number of parameters dictionary with keys exactly the same</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            as the `coef_variation_dict`. Values of `num_param_dict` records numbers of features in each kind of variable.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            If None is supplied, num_param_dict will be a dictionary with the same keys as the `coef_variation_dict` dictionary</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            and values of all ones. Default to be None.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        num_items (int): number of items in the dataset.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        num_users (int): number of users in the dataset.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        regularization (Optional[str]): this argument takes values from {&#39;L1&#39;, &#39;L2&#39;, None}, which specifies the type of</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">            regularization added to the log-likelihood.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">            - &#39;L1&#39; will subtract regularization_weight * 1-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">            - &#39;L2&#39; will subtract regularization_weight * 2-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">            - None does not modify the log-likelihood.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        regularization_weight (Optional[float]): the weight of parameter norm subtracted from the log-likelihood.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">            This term controls the strength of regularization. This argument is required if and only if regularization</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">            is not None.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        weight_initialization (Optional[Union[str, Dict[str, str]]]): controls for how coefficients are initialized;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">            users can pass a string from {&#39;normal&#39;, &#39;uniform&#39;, &#39;zero&#39;} to initialize all coefficients in the same way.</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">            Alternatively, users can pass a dictionary with keys exactly the same as the `coef_variation_dict` dictionary,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">            and values from {&#39;normal&#39;, &#39;uniform&#39;, &#39;zero&#39;} to initialize coefficients of different types of variables differently.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">            By default, all coefficients are initialized following a standard normal distribution.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="c1"># Check that the model received a valid combination of inputs so that it can be initialized.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">if</span> <span class="n">coef_variation_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either coef_variation_dict or formula should be provided to specify the model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">coef_variation_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of coef_variation_dict or formula should be provided to specify the model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If formula is provided, data should be provided to specify the model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="c1"># Build necessary dictionaries for model initialization.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="k">if</span> <span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="c1"># Use dictionaries to initialize the model.</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="k">if</span> <span class="n">num_param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`num_param_dict` is not provided, all variables will be treated as having one parameter.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="n">num_param_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="mi">1</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="k">assert</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">num_param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="c1"># variable `var` with variation `spec` to variable `var[spec]`.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">rename</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># old variable name --&gt; new variable name.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">specificity</span> <span class="ow">in</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">rename</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">specificity</span><span class="si">}</span><span class="s2">]&quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">for</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">coef_variation_dict</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">num_param_dict</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_param_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="c1"># Use the formula to infer model.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">coef_variation_dict</span><span class="p">,</span> <span class="n">num_param_dict</span> <span class="o">=</span> <span class="n">parse_formula</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="c1"># Model Initialization.</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="c1"># ==============================================================================================================</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">ConditionalLogitModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">coef_variation_dict</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">num_param_dict</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="n">num_items</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">num_users</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">regularization</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Provided regularization=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s2"> is not allowed, allowed values are [&#39;L1&#39;, &#39;L2&#39;, None].&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">=</span> <span class="n">regularization_weight</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified regularization type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s1"> without providing regularization_weight.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified no regularization but you provide regularization_weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span><span class="si">}</span><span class="s1">, you should leave regularization_weight as None if you do not want to regularize the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="c1"># check number of parameters specified are all positive.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">num_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">assert</span> <span class="n">num_params</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;num_params needs to be positive, got: </span><span class="si">{</span><span class="n">num_params</span><span class="si">}</span><span class="s1">.&#39;</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="c1"># infer the number of parameters for intercept if the researcher forgets.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">` key found in coef_variation_dict but not in num_param_dict, num_param_dict[&#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&#39;] has been set to 1.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="c1"># inform coefficients their ways of being initialized.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">weight_initialization</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="c1"># construct trainable parameters.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="n">coef_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">variation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="k">if</span> <span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="c1"># use the variable-specific initialization if provided.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                <span class="n">init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span><span class="p">[</span><span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="c1"># use default initialization.</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="n">init</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="c1"># initialize all coefficients in the same way.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_initialization</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">coef_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">Coefficient</span><span class="p">(</span><span class="n">variation</span><span class="o">=</span><span class="n">variation</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                                          <span class="n">num_items</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                                          <span class="n">num_users</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                                          <span class="n">num_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">],</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                                          <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="c1"># A ModuleDict is required to properly register all trainable parameters.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="c1"># self.parameter() will fail if a python dictionary is used instead.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">coef_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">coef_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return a string representation of the model.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>str</code></td>          <td>
                <code>str</code>
          </td>
          <td><p>the string representation of the model.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="sd">&quot;&quot;&quot;Return a string representation of the model.</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        str: the string representation of the model.</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">out_str_lst</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Conditional logistic discrete choice model, expects input features:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">num_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">out_str_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X[</span><span class="si">{</span><span class="n">var_type</span><span class="si">}</span><span class="s1">] with </span><span class="si">{</span><span class="n">num_params</span><span class="si">}</span><span class="s1"> parameters, with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span><span class="si">}</span><span class="s1"> level variation.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_str_lst</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;device=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">manual_coef_value_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Forward pass of the model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>a <code>ChoiceDataset</code> object.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>manual_coef_value_dict</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[str, torch.<span title="torch.Tensor">Tensor</span>]]</code>
          </td>
          <td><p>a dictionary with
keys in {'u', 'i'} etc and tensors as values. If provided, the model will force
coefficient to be the provided values and compute utility conditioned on the provided
coefficient values. This feature is useful when the research wishes to plug in particular
values of coefficients and examine the utility values. If not provided, the model will
use the learned coefficient values in self.coef_dict.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>torch.Tensor: a tensor of shape (num_trips, num_items) whose (t, i) entry represents
the utility from item i in trip t for the user involved in that trip.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="n">manual_coef_value_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">    Forward pass of the model.</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">        batch: a `ChoiceDataset` object.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">        manual_coef_value_dict (Optional[Dict[str, torch.Tensor]], optional): a dictionary with</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">            keys in {&#39;u&#39;, &#39;i&#39;} etc and tensors as values. If provided, the model will force</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">            coefficient to be the provided values and compute utility conditioned on the provided</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">            coefficient values. This feature is useful when the research wishes to plug in particular</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">            values of coefficients and examine the utility values. If not provided, the model will</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">            use the learned coefficient values in self.coef_dict.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        torch.Tensor: a tensor of shape (num_trips, num_items) whose (t, i) entry represents</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">            the utility from item i in trip t for the user involved in that trip.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="n">x_dict</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">x_dict</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="c1"># intercept term has no input tensor from the ChoiceDataset data structure.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="c1"># the tensor for intercept has only 1 feature, every entry is 1.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="n">x_dict</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="k">break</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="c1"># compute the utility from each item in each choice session.</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="n">total_utility</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="c1"># for each type of variables, apply the corresponding coefficient to input x.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="c1"># variable type is named as &quot;observable_name[variation]&quot;, retrieve the corresponding observable name.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">corresponding_observable</span> <span class="o">=</span> <span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">total_utility</span> <span class="o">+=</span> <span class="n">coef</span><span class="p">(</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="n">x_dict</span><span class="p">[</span><span class="n">corresponding_observable</span><span class="p">],</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">user_index</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="n">manual_coef_value</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">manual_coef_value_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">manual_coef_value_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">])</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">assert</span> <span class="n">total_utility</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>    <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">item_availability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="c1"># mask out unavailable items.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">total_utility</span><span class="p">[</span><span class="o">~</span><span class="n">batch</span><span class="o">.</span><span class="n">item_availability</span><span class="p">[</span><span class="n">batch</span><span class="o">.</span><span class="n">session_index</span><span class="p">,</span> <span class="p">:]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">total_utility</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="k">return</span> <span class="n">total_utility</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.get_coefficient" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_coefficient</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrieve the coefficient tensor for the given variable.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>variable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>the variable name.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>torch.Tensor: the corresponding coefficient tensor of the requested variable.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="k">def</span> <span class="nf">get_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="sd">&quot;&quot;&quot;Retrieve the coefficient tensor for the given variable.</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">        variable (str): the variable name.</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">        torch.Tensor: the corresponding coefficient tensor of the requested variable.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;coef_dict.</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">.coef&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">loss</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The loss function to be optimized. This is a wrapper of <code>negative_log_likelihood</code> + regularization loss if required.</p>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="sd">&quot;&quot;&quot;The loss function to be optimized. This is a wrapper of `negative_log_likelihood` + regularization loss if required.&quot;&quot;&quot;</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="n">nll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">L</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="p">]</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">nll</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">L</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="k">return</span> <span class="n">nll</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.negative_log_likelihood" class="doc doc-heading">
<code class="highlight language-python"><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the log-likelihood for the batch and label.
TODO: consider remove y, change to label.
TODO: consider move this method outside the model, the role of the model is to compute the utility.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>a ChoiceDataset object containing the data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>the label.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>is_train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>whether to trace the gradient. Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>torch.Tensor: the negative log-likelihood.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="k">def</span> <span class="nf">negative_log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="sd">&quot;&quot;&quot;Computes the log-likelihood for the batch and label.</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">    TODO: consider remove y, change to label.</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">    TODO: consider move this method outside the model, the role of the model is to compute the utility.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">        batch (ChoiceDataset): a ChoiceDataset object containing the data.</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        y (torch.Tensor): the label.</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">        is_train (bool, optional): whether to trace the gradient. Defaults to True.</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">        torch.Tensor: the negative log-likelihood.</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="c1"># (num_trips, num_items)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="n">total_utility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="n">logP</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">total_utility</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span> <span class="n">logP</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="k">return</span> <span class="n">nll</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.conditional_logit_model.ConditionalLogitModel.summary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">summary</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Print out the current model parameter.</p>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/conditional_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="sd">&quot;&quot;&quot;Print out the current model parameter.&quot;&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">if</span> <span class="n">coefficient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Variable Type: &#39;</span><span class="p">,</span> <span class="n">var_type</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">coefficient</span><span class="o">.</span><span class="n">coef</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">


<a id="torch_choice.model.NestedLogitModel"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code><span title="torch.nn">nn</span>.<span title="torch.nn.Module">Module</span></code></p>



        <details class="quote">
          <summary>Source code in <code>torch_choice/model/nested_logit_model.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">class</span> <span class="nc">NestedLogitModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>                 <span class="n">nest_to_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>                 <span class="c1"># method 1: specify variation and num param. dictionary.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>                 <span class="n">nest_coef_variation_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>                 <span class="n">nest_num_param_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>                 <span class="n">item_coef_variation_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>                 <span class="n">item_num_param_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                 <span class="c1"># method 2: specify formula and dataset.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                 <span class="n">item_formula</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>                 <span class="n">nest_formula</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>                 <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JointDataset</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>                 <span class="n">num_users</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>                 <span class="n">shared_lambda</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>                 <span class="n">regularization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>                 <span class="n">regularization_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>                 <span class="n">nest_weight_initialization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>                 <span class="n">item_weight_initialization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="sd">&quot;&quot;&quot;Initialization method of the nested logit model.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">            nest_to_item (Dict[object, List[int]]): a dictionary maps a nest ID to a list</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">                of items IDs of the queried nest.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">            nest_coef_variation_dict (Dict[str, str]): a dictionary maps a variable type</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">                (i.e., variable group) to the level of variation for the coefficient of this type</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">                of variables.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">            nest_num_param_dict (Dict[str, int]): a dictionary maps a variable type name to</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">                the number of parameters in this variable group.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">            item_coef_variation_dict (Dict[str, str]): the same as nest_coef_variation_dict but</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">                for item features.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">            item_num_param_dict (Dict[str, int]): the same as nest_num_param_dict but for item</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">                features.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            {nest, item}_formula (str): a string representing the utility formula for the {nest, item} level logit model.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">                The formula consists of &#39;(variable_name|variation)&#39;s separated by &#39;+&#39;, for example:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">                &quot;(var1|item) + (var2|user) + (var3|constant)&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">                where the first part of each term is the name of the variable</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">                and the second part is the variation of the coefficient.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">                The variation can be one of the following:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">                &#39;constant&#39;, &#39;item&#39;, &#39;item-full&#39;, &#39;user&#39;, &#39;user-item&#39;, &#39;user-item-full&#39;.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">                All spaces in the formula will be ignored, hence please do not use spaces in variable/observable names.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">            dataset (JointDataset): a JointDataset object for training the model, the parser will infer dimensions of variables</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">                and sizes of coefficients for the nest level model from dataset.datasets[&#39;nest&#39;]. The parser will infer dimensions of variables and sizes of coefficients for the item level model from dataset.datasets[&#39;item&#39;].</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            num_users (Optional[int], optional): number of users to be modelled, this is only</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">                required if any of variable type requires user-specific variations.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            shared_lambda (bool): a boolean indicating whether to enforce the elasticity lambda, which</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">                is the coefficient for inclusive values, to be constant for all nests.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">                The lambda enters the nest-level selection as the following</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">                Utility of choosing nest k = lambda * inclusive value of nest k</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">                                               + linear combination of some other nest level features</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">                If set to True, a single lambda will be learned for all nests, otherwise, the</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">                model learns an individual lambda for each nest.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">                Defaults to False.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">            regularization (Optional[str]): this argument takes values from {&#39;L1&#39;, &#39;L2&#39;, None}, which specifies the type of</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">                regularization added to the log-likelihood.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">                - &#39;L1&#39; will subtract regularization_weight * 1-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">                - &#39;L2&#39; will subtract regularization_weight * 2-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">                - None does not modify the log-likelihood.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            regularization_weight (Optional[float]): the weight of parameter norm subtracted from the log-likelihood.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">                This term controls the strength of regularization. This argument is required if and only if regularization</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">                is not None.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">            {nest, item}_weight_initialization (Optional[Union[str, Dict[str, str]]]): methods to initialize the weights of</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">                coefficients for {nest, item} level model. Please refer to the `weight_initialization` keyword in ConditionalLogitModel&#39;s documentation for more details.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="c1"># handle nest level model.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">using_formula_to_initiate</span> <span class="o">=</span> <span class="p">(</span><span class="n">item_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nest_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="k">if</span> <span class="n">using_formula_to_initiate</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="c1"># make sure that the research does not specify duplicated information, which might cause conflict.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nest_coef_variation_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_coef_variation_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You specify the {item, nest}_formula to initiate the model, you should not specify the {item, nest}_coef_variation_dict at the same time.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nest_num_param_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_num_param_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You specify the {item, nest}_formula to initiate the model, you should not specify the {item, nest}_num_param_dict at the same time.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dataset is required if {item, nest}_formula is specified to initiate the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">nest_coef_variation_dict</span><span class="p">,</span> <span class="n">nest_num_param_dict</span> <span class="o">=</span> <span class="n">parse_formula</span><span class="p">(</span><span class="n">nest_formula</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;nest&#39;</span><span class="p">])</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">item_coef_variation_dict</span><span class="p">,</span> <span class="n">item_num_param_dict</span> <span class="o">=</span> <span class="n">parse_formula</span><span class="p">(</span><span class="n">item_formula</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">])</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="c1"># check for conflicting information.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nest_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should not specify {item, nest}_formula and {item, nest}_coef_variation_dict at the same time.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="c1"># make sure that the research specifies all the required information.</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nest_coef_variation_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_coef_variation_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should specify the {item, nest}_coef_variation_dict to initiate the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nest_num_param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_num_param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should specify the {item, nest}_num_param_dict to initiate the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">NestedLogitModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nest_to_item</span> <span class="o">=</span> <span class="n">nest_to_item</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_variation_dict</span> <span class="o">=</span> <span class="n">nest_coef_variation_dict</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nest_num_param_dict</span> <span class="o">=</span> <span class="n">nest_num_param_dict</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">item_coef_variation_dict</span> <span class="o">=</span> <span class="n">item_coef_variation_dict</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">item_num_param_dict</span> <span class="o">=</span> <span class="n">item_num_param_dict</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">num_users</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nests</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nests</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">nest_to_item</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="c1"># nest coefficients.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_coef_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_variation_dict</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                                                    <span class="bp">self</span><span class="o">.</span><span class="n">nest_num_param_dict</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                                                    <span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                                                    <span class="n">weight_initialization</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">nest_weight_initialization</span><span class="p">))</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="c1"># item coefficients.</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">item_coef_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_coef_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_coef_variation_dict</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                                                    <span class="bp">self</span><span class="o">.</span><span class="n">item_num_param_dict</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                                                    <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                                                    <span class="n">weight_initialization</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item_weight_initialization</span><span class="p">))</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_lambda</span> <span class="o">=</span> <span class="n">shared_lambda</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_lambda</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="c1"># breakpoint()</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="c1"># self.iv_weights = nn.Parameter(torch.ones(1), requires_grad=True)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="c1"># used to warn users if forgot to call clamp.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clamp_called_flag</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> <span class="n">regularization</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Provided regularization=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s2"> is not allowed, allowed values are [&#39;L1&#39;, &#39;L2&#39;, None].&quot;</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">=</span> <span class="n">regularization_weight</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified regularization type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s1"> without providing regularization_weight.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified no regularization but you provide regularization_weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span><span class="si">}</span><span class="s1">, you should leave regularization_weight as None if you do not want to regularize the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="k">def</span> <span class="nf">num_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="sd">&quot;&quot;&quot;Get the total number of parameters. For example, if there is only an user-specific coefficient to be multiplied</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        with the K-dimensional observable, then the total number of parameters would be K x number of users, assuming no</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        intercept is involved.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">            int: the total number of learnable parameters.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">def</span> <span class="nf">_build_coef_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                         <span class="n">coef_variation_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                         <span class="n">num_param_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                         <span class="n">num_items</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                         <span class="n">weight_initialization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="sd">&quot;&quot;&quot;Builds a coefficient dictionary containing all trainable components of the model, mapping coefficient names</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">            to the corresponding Coefficient Module.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">            num_items could be the actual number of items or the number of nests depends on the use case.</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">            NOTE: torch-choice users don&#39;t directly interact with this method.</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">            coef_variation_dict (Dict[str, str]): a dictionary mapping coefficient names (e.g., theta_user) to the level</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">                of variation (e.g., &#39;user&#39;).</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">            num_param_dict (Dict[str, int]): a dictionary mapping coefficient names to the number of parameters in this</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">                coefficient. Be aware that, for example, if there is one K-dimensional coefficient for every user, then</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">                the `num_param` should be K instead of K x number of users.</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">            num_items (int): the total number of items in the prediction problem. `num_items` should be the number of nests if _build_coef_dict() is used for nest-level prediction.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">            nn.ModuleDict: a PyTorch ModuleDict object mapping from coefficient names to training Coefficient.</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">coef_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">variation</span> <span class="ow">in</span> <span class="n">coef_variation_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">num_params</span> <span class="o">=</span> <span class="n">num_param_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weight_initialization</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="k">if</span> <span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">weight_initialization</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                    <span class="c1"># use the variable-specific initialization if provided.</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                    <span class="n">init</span> <span class="o">=</span> <span class="n">weight_initialization</span><span class="p">[</span><span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                    <span class="c1"># use default initialization.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                    <span class="n">init</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="c1"># initialize all coefficients in the same way.</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">init</span> <span class="o">=</span> <span class="n">weight_initialization</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">coef_dict</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">Coefficient</span><span class="p">(</span><span class="n">variation</span><span class="o">=</span><span class="n">variation</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                                              <span class="n">num_items</span><span class="o">=</span><span class="n">num_items</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                                              <span class="n">num_users</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_users</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                                              <span class="n">num_params</span><span class="o">=</span><span class="n">num_params</span><span class="p">,</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                                              <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">coef_dict</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="sd">&quot;&quot;&quot;An standard forward method for the model, the user feeds a ChoiceDataset batch and the model returns the</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">            predicted log-likelihood tensor. The main forward passing happens in the _forward() method, but we provide</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">            this wrapper forward() method for a cleaner API, as forward() only requires a single batch argument.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">            For more details about the forward passing, please refer to the _forward() method.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        # TODO: the ConditionalLogitModel returns predicted utility, the NestedLogitModel behaves the same?</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">            batch (ChoiceDataset): a ChoiceDataset object containing the data batch.</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">            torch.Tensor: a tensor of shape (num_trips, num_items) including the log probability</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">            of choosing item i in trip t.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;nest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x_dict</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                             <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x_dict</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                             <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">user_index</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                             <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item_availability</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="k">def</span> <span class="nf">_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                 <span class="n">nest_x_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                 <span class="n">item_x_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                 <span class="n">user_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                 <span class="n">item_availability</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="sd">&quot;&quot;&quot;&quot;Computes log P[t, i] = the log probability for the user involved in trip t to choose item i.</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">        Let n denote the ID of the user involved in trip t, then P[t, i] = P_{ni} on page 86 of the</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">        book &quot;discrete choice methods with simulation&quot; by Train.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        The `_forward` method is an internal API, users should refer to the `forward` method.</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">            nest_x_dict (torch.Tensor): a dictionary mapping from nest-level feature names to the corresponding feature tensor.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">            item_x_dict (torch.Tensor): a dictionary mapping from item-level feature names to the corresponding feature tensor.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">                More details on the shape of the tensors can be found in the docstring of the `x_dict` method of `ChoiceDataset`.</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">            user_index (torch.LongTensor): a tensor of shape (num_trips,) indicating which user is</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">                making decision in each trip. Setting user_index = None assumes the same user is</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">                making decisions in all trips.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">            item_availability (torch.BoolTensor): a boolean tensor with shape (num_trips, num_items)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">                indicating the aviliability of items in each trip. If item_availability[t, i] = False,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">                the utility of choosing item i in trip t, V[t, i], will be set to -inf.</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">                Given the decomposition V[t, i] = W[t, k(i)] + Y[t, i] + eps, V[t, i] is set to -inf</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">                by setting Y[t, i] = -inf for unavilable items.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">            torch.Tensor: a tensor of shape (num_trips, num_items) including the log probability</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">            of choosing item i in trip t.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_lambda</span><span class="p">:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span><span class="p">)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="c1"># if not self._clamp_called_flag:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="c1">#     warnings.warn(&#39;Did you forget to call clamp_lambdas() after optimizer.step()?&#39;)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="c1"># The overall utility of item can be decomposed into V[item] = W[nest] + Y[item] + eps.</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">T</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item_x_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="n">device</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item_x_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="c1"># compute nest-specific utility with shape (T, num_nests).</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">W</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="n">nest_x_dict</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="k">break</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_coef_variation_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="n">item_x_dict</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                <span class="k">break</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">corresponding_observable</span> <span class="o">=</span> <span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="n">W</span> <span class="o">+=</span> <span class="n">coef</span><span class="p">(</span><span class="n">nest_x_dict</span><span class="p">[</span><span class="n">corresponding_observable</span><span class="p">],</span> <span class="n">user_index</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="c1"># compute item-specific utility (T, num_items).</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">Y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">for</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_coef_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="n">corresponding_observable</span> <span class="o">=</span> <span class="n">var_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">Y</span> <span class="o">+=</span> <span class="n">coef</span><span class="p">(</span><span class="n">item_x_dict</span><span class="p">[</span><span class="n">corresponding_observable</span><span class="p">],</span> <span class="n">user_index</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="k">if</span> <span class="n">item_availability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">Y</span><span class="p">[</span><span class="o">~</span><span class="n">item_availability</span><span class="p">]</span> <span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">min</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="c1"># =============================================================================</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="c1"># compute the inclusive value of each nest.</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">inclusive_value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">Bk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nest_to_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="c1"># for nest k, divide the Y of all items in Bk by lambda_k.</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">Y</span><span class="p">[:,</span> <span class="n">Bk</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="c1"># compute inclusive value for nest k.</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="c1"># mask out unavilable items.</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="n">inclusive_value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span> <span class="n">Bk</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># (T,)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="c1"># boardcast inclusive value from (T, num_nests) to (T, num_items).</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="c1"># for trip t, I[t, i] is the inclusive value of the nest item i belongs to.</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">Bk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nest_to_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="n">I</span><span class="p">[:,</span> <span class="n">Bk</span><span class="p">]</span> <span class="o">=</span> <span class="n">inclusive_value</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (T, |Bk|)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="c1"># logP_item[t, i] = log P(ni|Bk), where Bk is the nest item i is in, n is the user in trip t.</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">logP_item</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">I</span>  <span class="c1"># (T, num_items)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="c1"># =============================================================================</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="c1"># logP_nest[t, i] = log P(Bk), for item i in trip t, the probability of choosing the nest/bucket</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="c1"># item i belongs to. logP_nest has shape (T, num_items)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="c1"># logit[t, i] = W[n, k] + lambda[k] I[n, k], where n is the user involved in trip t, k is</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="c1"># the nest item i belongs to.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">logit</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">Bk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nest_to_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="n">logit</span><span class="p">[:,</span> <span class="n">Bk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambdas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">inclusive_value</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (T, |Bk|)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="c1"># only count each nest once in the logsumexp within the nest level model.</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nest_to_item</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="n">logP_nest</span> <span class="o">=</span> <span class="n">logit</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span><span class="n">logit</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="c1"># =============================================================================</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="c1"># compute the joint log P_{ni} as in the textbook.</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="n">logP</span> <span class="o">=</span> <span class="n">logP_item</span> <span class="o">+</span> <span class="n">logP_nest</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clamp_called_flag</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="k">return</span> <span class="n">logP</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="sd">&quot;&quot;&quot;Computes the log likelihood of the model, please refer to the negative_log_likelihood() method.</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">            _type_: the log likelihood of the model.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="k">return</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="k">def</span> <span class="nf">negative_log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                                <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                                <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                                <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">scalar_tensor</span><span class="p">:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="sd">&quot;&quot;&quot;Computes the negative log likelihood of the model. Please note the log-likelihood is summed over all samples</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">            in batch instead of the average.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">            batch (ChoiceDataset): the ChoiceDataset object containing the data.</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">            y (torch.LongTensor): the label.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">            is_train (bool, optional): which mode of the model to be used for the forward passing, if we need Hessian</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">                of the NLL through auto-grad, `is_train` should be set to True. If we merely need a performance metric,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">                then `is_train` can be set to False for better performance.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">                Defaults to True.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">            torch.scalar_tensor: the negative log likelihood of the model.</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="c1"># compute the negative log-likelihood loss directly.</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="c1"># (num_trips, num_items)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">logP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span> <span class="n">logP</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="k">return</span> <span class="n">nll</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="sd">&quot;&quot;&quot;The loss function to be optimized. This is a wrapper of `negative_log_likelihood` + regularization loss if required.&quot;&quot;&quot;</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="n">nll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">L</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="p">]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lambda_weight&#39;</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                    <span class="c1"># we don&#39;t regularize the lambda term, we only regularize coefficients.</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                <span class="n">nll</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">L</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="k">return</span> <span class="n">nll</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="sd">&quot;&quot;&quot;Returns the device of the coefficient.</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">            torch.device: the device of the model.</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_coef_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="k">def</span> <span class="nf">is_intercept_term</span><span class="p">(</span><span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="c1"># check if the given variable is an intercept (fixed effect) term.</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="c1"># intercept (fixed effect) terms are defined as &#39;intercept[*]&#39; and looks like &#39;intercept[user]&#39;, &#39;intercept[item]&#39;, etc.</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;intercept[&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="k">def</span> <span class="nf">get_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="sd">&quot;&quot;&quot;Retrieve the coefficient tensor for the given variable.</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">            variable (str): the variable name.</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">            level (str): from which level of model to extract the coefficient, can be &#39;item&#39; or &#39;nest&#39;. The `level` argument will be discarded if `variable` is `lambda`.</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">            torch.Tensor: the corresponding coefficient tensor of the requested variable.</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;lambda&#39;</span><span class="p">:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>        <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;nest&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level should be either &#39;item&#39; or &#39;nest&#39;, got </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">_coef_dict.</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">.coef&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.device" class="doc doc-heading">
<code class="highlight language-python"><span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the device of the coefficient.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.device">device</span></code>
          </td>
          <td><p>torch.device: the device of the model.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.num_params" class="doc doc-heading">
<code class="highlight language-python"><span class="n">num_params</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Get the total number of parameters. For example, if there is only an user-specific coefficient to be multiplied
with the K-dimensional observable, then the total number of parameters would be K x number of users, assuming no
intercept is involved.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
                <code>int</code>
          </td>
          <td><p>the total number of learnable parameters.</p></td>
        </tr>
    </tbody>
  </table>
  </div>

</div>



<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">nest_to_item</span><span class="p">,</span> <span class="n">nest_coef_variation_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nest_num_param_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_coef_variation_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_num_param_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nest_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_users</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regularization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regularization_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nest_weight_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">item_weight_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Initialization method of the nested logit model.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>nest_to_item</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[object, <span title="typing.List">List</span>[int]]</code>
          </td>
          <td><p>a dictionary maps a nest ID to a list
of items IDs of the queried nest.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nest_coef_variation_dict</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, str]</code>
          </td>
          <td><p>a dictionary maps a variable type
(i.e., variable group) to the level of variation for the coefficient of this type
of variables.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>nest_num_param_dict</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, int]</code>
          </td>
          <td><p>a dictionary maps a variable type name to
the number of parameters in this variable group.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>item_coef_variation_dict</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, str]</code>
          </td>
          <td><p>the same as nest_coef_variation_dict but
for item features.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>item_num_param_dict</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, int]</code>
          </td>
          <td><p>the same as nest_num_param_dict but for item
features.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>{nest,</code></td>
          <td>
                <code>item}_formula (str</code>
          </td>
          <td><p>a string representing the utility formula for the {nest, item} level logit model.
The formula consists of '(variable_name|variation)'s separated by '+', for example:
"(var1|item) + (var2|user) + (var3|constant)"
where the first part of each term is the name of the variable
and the second part is the variation of the coefficient.
The variation can be one of the following:
'constant', 'item', 'item-full', 'user', 'user-item', 'user-item-full'.
All spaces in the formula will be ignored, hence please do not use spaces in variable/observable names.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dataset</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.joint_dataset.JointDataset" href="#torch_choice.data.JointDataset">JointDataset</a></code>
          </td>
          <td><p>a JointDataset object for training the model, the parser will infer dimensions of variables
and sizes of coefficients for the nest level model from dataset.datasets['nest']. The parser will infer dimensions of variables and sizes of coefficients for the item level model from dataset.datasets['item'].</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>num_users</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>number of users to be modelled, this is only
required if any of variable type requires user-specific variations.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>shared_lambda</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>a boolean indicating whether to enforce the elasticity lambda, which
is the coefficient for inclusive values, to be constant for all nests.
The lambda enters the nest-level selection as the following
Utility of choosing nest k = lambda * inclusive value of nest k
                               + linear combination of some other nest level features
If set to True, a single lambda will be learned for all nests, otherwise, the
model learns an individual lambda for each nest.
Defaults to False.</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>regularization</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td><p>this argument takes values from {'L1', 'L2', None}, which specifies the type of
regularization added to the log-likelihood.
- 'L1' will subtract regularization_weight * 1-norm of parameters from the log-likelihood.
- 'L2' will subtract regularization_weight * 2-norm of parameters from the log-likelihood.
- None does not modify the log-likelihood.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>regularization_weight</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[float]</code>
          </td>
          <td><p>the weight of parameter norm subtracted from the log-likelihood.
This term controls the strength of regularization. This argument is required if and only if regularization
is not None.
Defaults to None.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>{nest,</code></td>
          <td>
                <code>item}_weight_initialization (Optional[Union[str, Dict[str, str]]]</code>
          </td>
          <td><p>methods to initialize the weights of
coefficients for {nest, item} level model. Please refer to the <code>weight_initialization</code> keyword in ConditionalLogitModel's documentation for more details.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/nested_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>             <span class="n">nest_to_item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>             <span class="c1"># method 1: specify variation and num param. dictionary.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>             <span class="n">nest_coef_variation_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>             <span class="n">nest_num_param_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>             <span class="n">item_coef_variation_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>             <span class="n">item_num_param_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>             <span class="c1"># method 2: specify formula and dataset.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>             <span class="n">item_formula</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>             <span class="n">nest_formula</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>             <span class="n">dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">JointDataset</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>             <span class="n">num_users</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>             <span class="n">shared_lambda</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>             <span class="n">regularization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>             <span class="n">regularization_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>             <span class="n">nest_weight_initialization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>             <span class="n">item_weight_initialization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>             <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="sd">&quot;&quot;&quot;Initialization method of the nested logit model.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        nest_to_item (Dict[object, List[int]]): a dictionary maps a nest ID to a list</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">            of items IDs of the queried nest.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        nest_coef_variation_dict (Dict[str, str]): a dictionary maps a variable type</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            (i.e., variable group) to the level of variation for the coefficient of this type</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            of variables.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        nest_num_param_dict (Dict[str, int]): a dictionary maps a variable type name to</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            the number of parameters in this variable group.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        item_coef_variation_dict (Dict[str, str]): the same as nest_coef_variation_dict but</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">            for item features.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        item_num_param_dict (Dict[str, int]): the same as nest_num_param_dict but for item</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            features.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        {nest, item}_formula (str): a string representing the utility formula for the {nest, item} level logit model.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            The formula consists of &#39;(variable_name|variation)&#39;s separated by &#39;+&#39;, for example:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            &quot;(var1|item) + (var2|user) + (var3|constant)&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            where the first part of each term is the name of the variable</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            and the second part is the variation of the coefficient.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            The variation can be one of the following:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            &#39;constant&#39;, &#39;item&#39;, &#39;item-full&#39;, &#39;user&#39;, &#39;user-item&#39;, &#39;user-item-full&#39;.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            All spaces in the formula will be ignored, hence please do not use spaces in variable/observable names.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        dataset (JointDataset): a JointDataset object for training the model, the parser will infer dimensions of variables</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">            and sizes of coefficients for the nest level model from dataset.datasets[&#39;nest&#39;]. The parser will infer dimensions of variables and sizes of coefficients for the item level model from dataset.datasets[&#39;item&#39;].</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        num_users (Optional[int], optional): number of users to be modelled, this is only</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">            required if any of variable type requires user-specific variations.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        shared_lambda (bool): a boolean indicating whether to enforce the elasticity lambda, which</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            is the coefficient for inclusive values, to be constant for all nests.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            The lambda enters the nest-level selection as the following</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">            Utility of choosing nest k = lambda * inclusive value of nest k</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">                                           + linear combination of some other nest level features</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            If set to True, a single lambda will be learned for all nests, otherwise, the</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            model learns an individual lambda for each nest.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            Defaults to False.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        regularization (Optional[str]): this argument takes values from {&#39;L1&#39;, &#39;L2&#39;, None}, which specifies the type of</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">            regularization added to the log-likelihood.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            - &#39;L1&#39; will subtract regularization_weight * 1-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            - &#39;L2&#39; will subtract regularization_weight * 2-norm of parameters from the log-likelihood.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            - None does not modify the log-likelihood.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        regularization_weight (Optional[float]): the weight of parameter norm subtracted from the log-likelihood.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            This term controls the strength of regularization. This argument is required if and only if regularization</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            is not None.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        {nest, item}_weight_initialization (Optional[Union[str, Dict[str, str]]]): methods to initialize the weights of</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">            coefficients for {nest, item} level model. Please refer to the `weight_initialization` keyword in ConditionalLogitModel&#39;s documentation for more details.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="c1"># handle nest level model.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="n">using_formula_to_initiate</span> <span class="o">=</span> <span class="p">(</span><span class="n">item_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nest_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">if</span> <span class="n">using_formula_to_initiate</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="c1"># make sure that the research does not specify duplicated information, which might cause conflict.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nest_coef_variation_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_coef_variation_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You specify the {item, nest}_formula to initiate the model, you should not specify the {item, nest}_coef_variation_dict at the same time.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nest_num_param_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_num_param_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You specify the {item, nest}_formula to initiate the model, you should not specify the {item, nest}_num_param_dict at the same time.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dataset is required if {item, nest}_formula is specified to initiate the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">nest_coef_variation_dict</span><span class="p">,</span> <span class="n">nest_num_param_dict</span> <span class="o">=</span> <span class="n">parse_formula</span><span class="p">(</span><span class="n">nest_formula</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;nest&#39;</span><span class="p">])</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">item_coef_variation_dict</span><span class="p">,</span> <span class="n">item_num_param_dict</span> <span class="o">=</span> <span class="n">parse_formula</span><span class="p">(</span><span class="n">item_formula</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">])</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="c1"># check for conflicting information.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nest_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should not specify {item, nest}_formula and {item, nest}_coef_variation_dict at the same time.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="c1"># make sure that the research specifies all the required information.</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nest_coef_variation_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_coef_variation_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should specify the {item, nest}_coef_variation_dict to initiate the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nest_num_param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item_num_param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You should specify the {item, nest}_num_param_dict to initiate the model.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="nb">super</span><span class="p">(</span><span class="n">NestedLogitModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nest_to_item</span> <span class="o">=</span> <span class="n">nest_to_item</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_variation_dict</span> <span class="o">=</span> <span class="n">nest_coef_variation_dict</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nest_num_param_dict</span> <span class="o">=</span> <span class="n">nest_num_param_dict</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">item_coef_variation_dict</span> <span class="o">=</span> <span class="n">item_coef_variation_dict</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">item_num_param_dict</span> <span class="o">=</span> <span class="n">item_num_param_dict</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">num_users</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nests</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nests</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">nest_to_item</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="c1"># nest coefficients.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_coef_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nest_coef_variation_dict</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">nest_num_param_dict</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                                                <span class="n">weight_initialization</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">nest_weight_initialization</span><span class="p">))</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="c1"># item coefficients.</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">item_coef_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_coef_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_coef_variation_dict</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">item_num_param_dict</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                                                <span class="bp">self</span><span class="o">.</span><span class="n">num_items</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                                                <span class="n">weight_initialization</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item_weight_initialization</span><span class="p">))</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">shared_lambda</span> <span class="o">=</span> <span class="n">shared_lambda</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_lambda</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nests</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="c1"># breakpoint()</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="c1"># self.iv_weights = nn.Parameter(torch.ones(1), requires_grad=True)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="c1"># used to warn users if forgot to call clamp.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_clamp_called_flag</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="o">=</span> <span class="n">regularization</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Provided regularization=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s2"> is not allowed, allowed values are [&#39;L1&#39;, &#39;L2&#39;, None].&quot;</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">=</span> <span class="n">regularization_weight</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified regularization type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="si">}</span><span class="s1"> without providing regularization_weight.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You specified no regularization but you provide regularization_weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span><span class="si">}</span><span class="s1">, you should leave regularization_weight as None if you do not want to regularize the model.&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>An standard forward method for the model, the user feeds a ChoiceDataset batch and the model returns the
    predicted log-likelihood tensor. The main forward passing happens in the _forward() method, but we provide
    this wrapper forward() method for a cleaner API, as forward() only requires a single batch argument.
    For more details about the forward passing, please refer to the _forward() method.</p>
<h3 id="torch_choice.model.nested_logit_model.NestedLogitModel.forward--todo-the-conditionallogitmodel-returns-predicted-utility-the-nestedlogitmodel-behaves-the-same">TODO: the ConditionalLogitModel returns predicted utility, the NestedLogitModel behaves the same?</h3>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>a ChoiceDataset object containing the data batch.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>torch.Tensor: a tensor of shape (num_trips, num_items) including the log probability</p></td>
        </tr>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>of choosing item i in trip t.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/nested_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="sd">&quot;&quot;&quot;An standard forward method for the model, the user feeds a ChoiceDataset batch and the model returns the</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        predicted log-likelihood tensor. The main forward passing happens in the _forward() method, but we provide</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        this wrapper forward() method for a cleaner API, as forward() only requires a single batch argument.</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        For more details about the forward passing, please refer to the _forward() method.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">    # TODO: the ConditionalLogitModel returns predicted utility, the NestedLogitModel behaves the same?</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        batch (ChoiceDataset): a ChoiceDataset object containing the data batch.</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">        torch.Tensor: a tensor of shape (num_trips, num_items) including the log probability</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        of choosing item i in trip t.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;nest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x_dict</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                         <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x_dict</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                         <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">user_index</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                         <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item_availability</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.get_coefficient" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_coefficient</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrieve the coefficient tensor for the given variable.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>variable</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>the variable name.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>level</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>from which level of model to extract the coefficient, can be 'item' or 'nest'. The <code>level</code> argument will be discarded if <code>variable</code> is <code>lambda</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>torch.Tensor: the corresponding coefficient tensor of the requested variable.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/nested_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="k">def</span> <span class="nf">get_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="sd">&quot;&quot;&quot;Retrieve the coefficient tensor for the given variable.</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        variable (str): the variable name.</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="sd">        level (str): from which level of model to extract the coefficient, can be &#39;item&#39; or &#39;nest&#39;. The `level` argument will be discarded if `variable` is `lambda`.</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        torch.Tensor: the corresponding coefficient tensor of the requested variable.</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>    <span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;lambda&#39;</span><span class="p">:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_weight</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>    <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;nest&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Level should be either &#39;item&#39; or &#39;nest&#39;, got </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s1">_coef_dict.</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">.coef&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.log_likelihood" class="doc doc-heading">
<code class="highlight language-python"><span class="n">log_likelihood</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the log likelihood of the model, please refer to the negative_log_likelihood() method.</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>_type_</code></td>          <td>
          </td>
          <td><p>the log likelihood of the model.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/nested_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="sd">&quot;&quot;&quot;Computes the log likelihood of the model, please refer to the negative_log_likelihood() method.</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">        _type_: the log likelihood of the model.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="k">return</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.loss" class="doc doc-heading">
<code class="highlight language-python"><span class="n">loss</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The loss function to be optimized. This is a wrapper of <code>negative_log_likelihood</code> + regularization loss if required.</p>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/nested_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-378" name="__codelineno-0-378"></a><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="sd">&quot;&quot;&quot;The loss function to be optimized. This is a wrapper of `negative_log_likelihood` + regularization loss if required.&quot;&quot;&quot;</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="n">nll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="n">L</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">regularization</span><span class="p">]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;lambda_weight&#39;</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                <span class="c1"># we don&#39;t regularize the lambda term, we only regularize coefficients.</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                <span class="k">continue</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="n">nll</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularization_weight</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">L</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="k">return</span> <span class="n">nll</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="torch_choice.model.nested_logit_model.NestedLogitModel.negative_log_likelihood" class="doc doc-heading">
<code class="highlight language-python"><span class="n">negative_log_likelihood</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Computes the negative log likelihood of the model. Please note the log-likelihood is summed over all samples
    in batch instead of the average.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="torch_choice.data.choice_dataset.ChoiceDataset" href="#torch_choice.data.ChoiceDataset">ChoiceDataset</a></code>
          </td>
          <td><p>the ChoiceDataset object containing the data.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y</code></td>
          <td>
                <code>torch.<span title="torch.LongTensor">LongTensor</span></code>
          </td>
          <td><p>the label.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>is_train</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>which mode of the model to be used for the forward passing, if we need Hessian
of the NLL through auto-grad, <code>is_train</code> should be set to True. If we merely need a performance metric,
then <code>is_train</code> can be set to False for better performance.
Defaults to True.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.scalar_tensor">scalar_tensor</span></code>
          </td>
          <td><p>torch.scalar_tensor: the negative log likelihood of the model.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>torch_choice/model/nested_logit_model.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="k">def</span> <span class="nf">negative_log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                            <span class="n">batch</span><span class="p">:</span> <span class="n">ChoiceDataset</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                            <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                            <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">scalar_tensor</span><span class="p">:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>    <span class="sd">&quot;&quot;&quot;Computes the negative log likelihood of the model. Please note the log-likelihood is summed over all samples</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">        in batch instead of the average.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">        batch (ChoiceDataset): the ChoiceDataset object containing the data.</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">        y (torch.LongTensor): the label.</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        is_train (bool, optional): which mode of the model to be used for the forward passing, if we need Hessian</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">            of the NLL through auto-grad, `is_train` should be set to True. If we merely need a performance metric,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">            then `is_train` can be set to False for better performance.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">            Defaults to True.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">        torch.scalar_tensor: the negative log likelihood of the model.</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="c1"># compute the negative log-likelihood loss directly.</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="k">if</span> <span class="n">is_train</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="c1"># (num_trips, num_items)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="n">logP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">nll</span> <span class="o">=</span> <span class="o">-</span> <span class="n">logP</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="k">return</span> <span class="n">nll</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../test/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Compatibility Tests" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Compatibility Tests
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>