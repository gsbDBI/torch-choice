
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://gsbdbi.github.io/torch-choice/nested_logit_model_house_cooling/">
      
      
        <link rel="prev" href="../conditional_logit_model_mode_canada/">
      
      
        <link rel="next" href="../post_estimation_demos/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.1, mkdocs-material-9.1.21">
    
    
      
        <title>Nested Logit Model - Torch Choice</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.eebd395e.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#random-utility-model-rum-part-ii-nested-logit-model" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Torch Choice" class="md-header__button md-logo" aria-label="Torch Choice" data-md-component="logo">
      
  
  <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="500.000000pt" height="500.000000pt" viewBox="0 0 500.000000 500.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,500.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M3039 4192 c-24 -15 -53 -32 -64 -38 -16 -9 -19 -19 -15 -55 2 -24 4
-60 4 -79 l1 -35 -83 -3 c-81 -3 -83 -3 -102 -35 -23 -38 -35 -87 -23 -96 4
-3 30 -32 56 -63 47 -55 48 -57 28 -70 -12 -7 -21 -20 -21 -28 0 -8 -18 -28
-40 -43 -45 -32 -47 -43 -21 -106 22 -53 34 -59 127 -60 86 -1 87 -4 78 -105
l-6 -71 62 -33 c35 -17 69 -32 77 -32 8 0 38 23 67 50 66 62 92 65 150 13 22
-20 43 -40 44 -45 2 -4 -38 -8 -88 -8 -106 0 -151 -19 -174 -73 -7 -18 -25
-38 -39 -46 -23 -12 -34 -11 -93 5 -78 22 -87 37 -82 129 l3 60 -42 3 c-41 3
-42 4 -58 55 -24 74 -91 196 -120 219 -28 22 -32 50 -10 68 31 26 18 64 -37
111 -58 49 -122 89 -142 89 -7 0 -28 -10 -47 -23 l-34 -23 -65 22 c-63 20 -65
22 -68 57 -2 19 -10 41 -18 48 -9 8 -57 14 -122 17 -119 5 -137 -3 -144 -63
-3 -26 -9 -31 -66 -47 l-62 -19 -27 26 c-38 35 -74 32 -147 -12 -94 -56 -96
-59 -96 -122 -1 -74 -15 -93 -72 -90 -54 3 -59 0 -106 -64 -46 -62 -52 -76
-61 -144 -7 -51 -7 -52 26 -70 18 -9 33 -19 33 -21 0 -2 -9 -35 -21 -73 -18
-60 -26 -71 -53 -83 -55 -23 -61 -37 -46 -119 24 -133 24 -144 0 -174 -74 -93
-173 -235 -200 -284 -25 -47 -30 -68 -30 -122 0 -59 3 -69 27 -92 16 -15 45
-35 66 -46 21 -11 40 -28 43 -37 3 -9 12 -31 21 -49 13 -27 14 -37 3 -62 -15
-38 -6 -67 24 -75 23 -6 24 -10 28 -118 4 -138 25 -191 97 -243 66 -49 144
-65 306 -65 l135 0 0 -126 c0 -119 -1 -125 -19 -119 -21 6 -19 14 -97 -355
-47 -221 -52 -277 -28 -287 16 -6 97 1 319 27 220 26 482 49 513 45 21 -2 91
-9 157 -15 66 -6 201 -21 300 -33 202 -23 231 -25 247 -9 8 8 3 55 -21 174
-18 90 -39 197 -47 238 -8 41 -22 105 -30 143 -15 64 -18 67 -45 67 l-29 0 0
134 c0 127 1 134 23 149 12 8 42 33 66 56 34 31 50 39 68 35 13 -4 30 -1 38 6
11 9 32 11 69 6 30 -3 74 -3 98 0 39 5 46 11 60 43 38 86 104 116 161 71 14
-11 28 -20 32 -20 21 0 225 190 225 210 0 6 -9 29 -21 51 -14 28 -18 50 -14
70 7 32 50 89 67 89 5 0 23 9 39 21 l29 20 0 137 c0 153 -8 181 -55 197 -45
15 -54 23 -70 63 -14 33 -14 40 7 100 l23 63 -100 95 c-55 52 -111 98 -124
101 -14 3 -35 -1 -51 -11 -16 -9 -42 -16 -59 -16 -26 0 -36 9 -71 59 -22 33
-40 64 -40 70 0 5 20 17 45 26 72 28 81 44 66 116 -16 80 -8 89 75 89 56 0 68
4 95 28 23 21 32 39 36 72 5 44 4 46 -46 88 -28 24 -51 52 -51 62 0 11 23 42
50 69 56 56 63 85 30 138 -23 38 -66 52 -137 46 -30 -3 -53 -1 -57 5 -4 6 -1
42 5 79 13 75 20 64 -71 123 -25 16 -53 30 -64 30 -10 0 -40 -22 -66 -50 -39
-41 -54 -50 -83 -50 -28 0 -43 9 -83 50 -27 28 -56 50 -65 50 -8 0 -35 -12
-60 -28z m83 -129 c38 -37 40 -38 121 -39 l82 -1 37 39 c54 56 68 51 68 -22 0
-109 37 -147 146 -152 l69 -3 -52 -49 c-51 -48 -53 -52 -53 -103 0 -56 5 -64
70 -115 19 -15 32 -29 29 -32 -3 -3 -36 -8 -72 -11 -76 -5 -97 -16 -122 -58
-14 -24 -16 -43 -11 -97 8 -86 -5 -93 -58 -33 l-38 43 -92 0 -92 0 -39 -40
c-21 -22 -45 -40 -52 -40 -16 0 -17 32 -3 80 9 31 6 40 -24 86 l-35 52 -70 4
c-38 2 -74 7 -78 12 -8 7 16 30 71 69 23 16 26 25 26 77 0 58 -1 59 -50 102
-27 24 -50 46 -50 51 0 4 29 7 64 7 83 0 91 4 128 57 28 42 30 48 19 83 -24
81 -1 93 61 33z m-957 -243 c12 -37 33 -51 105 -71 25 -7 71 -26 104 -43 55
-29 59 -30 70 -13 30 49 29 49 66 19 34 -29 34 -29 17 -55 -23 -35 -22 -40 16
-78 46 -47 101 -144 133 -236 32 -93 50 -116 80 -109 17 5 23 0 28 -17 12 -45
7 -56 -33 -68 -38 -11 -39 -12 -59 -96 -29 -115 -89 -236 -151 -303 -28 -30
-51 -57 -51 -60 0 -4 7 -15 15 -26 21 -27 19 -39 -10 -58 -24 -16 -27 -15 -54
5 l-30 22 -48 -20 c-47 -20 -85 -30 -191 -54 -58 -12 -82 -36 -82 -82 0 -27
-2 -28 -42 -25 -43 3 -43 3 -46 44 -4 52 -20 66 -102 88 -36 10 -88 31 -116
47 -61 34 -71 35 -99 9 l-21 -20 -24 25 c-20 21 -21 28 -11 53 14 34 4 67 -29
97 -24 21 -74 124 -85 173 -9 43 -38 66 -74 59 -25 -5 -31 -2 -42 24 -13 33
-3 49 32 49 28 0 37 22 53 125 8 55 21 115 29 134 19 44 12 67 -24 80 -33 12
-36 26 -10 60 17 22 21 23 51 12 37 -13 34 -14 127 76 50 49 53 55 53 102 0
46 3 52 30 66 29 15 31 15 39 -8 13 -32 37 -40 71 -23 16 7 70 24 121 37 90
22 92 23 107 61 14 35 19 39 45 36 25 -2 33 -10 42 -38z m1193 -739 c23 -55
63 -83 140 -96 33 -5 52 -2 88 15 l46 23 46 -46 45 -45 -26 -32 c-31 -37 -32
-46 -11 -97 61 -144 74 -165 114 -181 l40 -17 0 -66 c0 -62 -2 -67 -23 -73
-49 -12 -105 -96 -138 -204 -11 -38 -10 -43 15 -73 l27 -32 -47 -48 -47 -48
-38 25 c-46 29 -90 30 -144 5 -47 -22 -79 -55 -92 -96 -9 -29 -13 -30 -71 -33
l-61 -3 -10 39 c-13 48 -34 68 -100 93 -64 24 -89 24 -121 -1 -34 -27 -45 -25
-101 15 l-48 36 25 37 c33 47 28 76 -28 190 -38 76 -47 88 -73 92 -27 5 -30 9
-33 45 -6 64 6 98 40 120 35 22 50 46 92 149 33 77 29 118 -12 124 -29 4 -28
16 3 36 14 9 34 34 45 56 l20 40 40 -21 c95 -50 238 -1 254 87 l7 34 58 0 58
0 21 -49z m-1922 -218 c3 -10 10 -25 15 -33 35 -55 38 -75 21 -124 l-17 -47
65 -62 c116 -111 142 -123 187 -87 22 17 28 18 56 6 99 -42 107 -49 119 -93
16 -66 33 -73 171 -73 l118 0 23 53 c23 50 26 53 77 66 30 8 60 16 66 18 7 3
21 -9 30 -26 26 -45 55 -40 156 28 l87 60 0 -69 c0 -47 6 -78 17 -99 20 -34
57 -54 84 -46 14 5 19 1 19 -14 0 -11 5 -31 11 -45 10 -20 8 -33 -10 -70 -11
-25 -21 -49 -21 -53 0 -9 -106 -109 -198 -184 l-72 -61 -101 89 c-125 109
-123 107 -142 100 -23 -9 -48 -52 -41 -70 3 -9 45 -51 92 -93 48 -43 91 -83
95 -90 8 -15 8 -15 -96 -101 -82 -68 -101 -99 -84 -134 19 -37 57 -36 100 3
40 37 114 101 166 144 19 16 73 63 120 105 47 42 97 84 110 95 13 10 44 36 68
57 46 39 55 39 88 2 6 -7 35 -30 65 -53 l54 -41 22 20 c33 31 94 36 118 10 14
-15 17 -26 10 -40 -8 -18 -107 -101 -149 -126 -15 -9 -16 -32 -15 -212 1 -199
0 -202 -22 -217 -13 -9 -66 -52 -118 -96 -214 -179 -305 -252 -332 -266 -33
-17 -16 -28 -179 105 -98 80 -135 111 -220 185 -20 17 -60 51 -88 75 l-51 43
0 183 c0 157 -2 184 -16 196 -13 10 -66 15 -203 19 -173 5 -189 7 -235 30 -75
37 -85 58 -90 175 -3 90 -37 247 -63 287 -3 6 -7 24 -8 40 -3 37 -38 74 -95
102 -45 22 -45 22 -43 70 3 41 11 58 60 122 32 42 72 96 90 122 72 105 94 132
109 132 8 0 17 -8 20 -17z m1314 -43 c0 -17 -27 -77 -38 -84 -19 -12 -19 32 0
63 20 31 38 41 38 21z m-846 -1553 c47 -41 68 -59 116 -97 76 -59 81 -64 134
-111 28 -26 62 -56 76 -67 l25 -20 -45 -6 c-112 -14 -234 -26 -338 -32 l-113
-7 5 24 c3 13 10 53 16 89 18 104 40 212 51 248 12 36 9 37 73 -21z m1135
-148 c18 -99 31 -182 28 -185 -4 -4 -214 12 -267 20 -8 2 -49 6 -91 10 -42 5
-81 11 -88 15 -10 7 174 163 314 268 24 17 46 37 50 42 3 6 9 11 14 11 4 0 22
-81 40 -181z"/>
<path d="M3180 3892 c-81 -36 -130 -127 -110 -204 22 -78 100 -138 182 -138
38 0 99 23 97 38 -1 20 -64 55 -102 57 -28 2 -46 9 -59 25 -32 39 -33 67 -4
105 25 32 31 35 81 35 34 0 55 5 58 13 2 6 7 10 10 7 4 -3 0 -18 -7 -32 -8
-15 -10 -31 -5 -39 5 -8 7 -21 4 -29 -11 -41 -14 -91 -5 -85 5 3 8 0 5 -7 -3
-7 5 -19 17 -27 20 -12 24 -11 45 15 61 77 27 223 -62 260 -35 14 -118 18
-145 6z m167 -244 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z"/>
<path d="M1913 3682 c-82 -29 -123 -49 -160 -79 -113 -96 -169 -183 -194 -301
-23 -109 -23 -165 0 -273 28 -135 83 -219 211 -320 117 -93 318 -126 476 -79
38 12 80 26 94 33 70 33 200 160 236 229 95 184 77 449 -42 605 -51 67 -159
149 -230 176 -159 59 -238 61 -391 9z m288 -83 c111 -35 229 -128 283 -223 92
-161 65 -364 -68 -518 -22 -26 -45 -48 -50 -48 -6 0 -19 -9 -30 -19 -29 -27
-114 -59 -192 -71 -105 -17 -201 9 -326 88 -63 39 -137 156 -164 257 -57 213
91 459 319 531 52 16 182 18 228 3z"/>
<path d="M2057 3373 c-19 -5 -44 -51 -102 -185 -21 -49 -41 -88 -45 -88 -8 0
-17 25 -65 169 -26 78 -57 107 -98 92 -22 -9 -27 -17 -27 -46 0 -19 9 -61 19
-92 10 -32 36 -111 56 -175 44 -141 69 -182 111 -186 38 -4 45 4 88 105 48
113 88 193 96 193 4 0 14 -17 23 -37 52 -125 101 -230 114 -245 9 -10 28 -18
43 -18 50 0 68 35 159 312 22 70 41 135 41 145 0 28 -20 43 -56 43 -35 0 -50
-14 -64 -57 -5 -15 -24 -71 -43 -123 l-35 -94 -35 74 c-19 41 -44 97 -56 125
-37 83 -65 103 -124 88z"/>
<path d="M3185 2891 c-118 -33 -200 -113 -243 -235 -20 -59 -23 -82 -18 -138
11 -117 71 -219 171 -288 80 -55 247 -65 338 -21 68 33 142 105 173 169 36 75
45 204 20 280 -40 119 -140 208 -263 236 -87 19 -102 19 -178 -3z m200 -112
c167 -88 205 -287 78 -410 -65 -63 -104 -81 -177 -82 -69 0 -129 25 -184 77
-133 124 -85 345 90 421 51 22 146 19 193 -6z"/>
</g>
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Torch Choice
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Nested Logit Model
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Torch Choice" class="md-nav__button md-logo" aria-label="Torch Choice" data-md-component="logo">
      
  
  <?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN"
 "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd">
<svg version="1.0" xmlns="http://www.w3.org/2000/svg"
 width="500.000000pt" height="500.000000pt" viewBox="0 0 500.000000 500.000000"
 preserveAspectRatio="xMidYMid meet">

<g transform="translate(0.000000,500.000000) scale(0.100000,-0.100000)"
fill="#000000" stroke="none">
<path d="M3039 4192 c-24 -15 -53 -32 -64 -38 -16 -9 -19 -19 -15 -55 2 -24 4
-60 4 -79 l1 -35 -83 -3 c-81 -3 -83 -3 -102 -35 -23 -38 -35 -87 -23 -96 4
-3 30 -32 56 -63 47 -55 48 -57 28 -70 -12 -7 -21 -20 -21 -28 0 -8 -18 -28
-40 -43 -45 -32 -47 -43 -21 -106 22 -53 34 -59 127 -60 86 -1 87 -4 78 -105
l-6 -71 62 -33 c35 -17 69 -32 77 -32 8 0 38 23 67 50 66 62 92 65 150 13 22
-20 43 -40 44 -45 2 -4 -38 -8 -88 -8 -106 0 -151 -19 -174 -73 -7 -18 -25
-38 -39 -46 -23 -12 -34 -11 -93 5 -78 22 -87 37 -82 129 l3 60 -42 3 c-41 3
-42 4 -58 55 -24 74 -91 196 -120 219 -28 22 -32 50 -10 68 31 26 18 64 -37
111 -58 49 -122 89 -142 89 -7 0 -28 -10 -47 -23 l-34 -23 -65 22 c-63 20 -65
22 -68 57 -2 19 -10 41 -18 48 -9 8 -57 14 -122 17 -119 5 -137 -3 -144 -63
-3 -26 -9 -31 -66 -47 l-62 -19 -27 26 c-38 35 -74 32 -147 -12 -94 -56 -96
-59 -96 -122 -1 -74 -15 -93 -72 -90 -54 3 -59 0 -106 -64 -46 -62 -52 -76
-61 -144 -7 -51 -7 -52 26 -70 18 -9 33 -19 33 -21 0 -2 -9 -35 -21 -73 -18
-60 -26 -71 -53 -83 -55 -23 -61 -37 -46 -119 24 -133 24 -144 0 -174 -74 -93
-173 -235 -200 -284 -25 -47 -30 -68 -30 -122 0 -59 3 -69 27 -92 16 -15 45
-35 66 -46 21 -11 40 -28 43 -37 3 -9 12 -31 21 -49 13 -27 14 -37 3 -62 -15
-38 -6 -67 24 -75 23 -6 24 -10 28 -118 4 -138 25 -191 97 -243 66 -49 144
-65 306 -65 l135 0 0 -126 c0 -119 -1 -125 -19 -119 -21 6 -19 14 -97 -355
-47 -221 -52 -277 -28 -287 16 -6 97 1 319 27 220 26 482 49 513 45 21 -2 91
-9 157 -15 66 -6 201 -21 300 -33 202 -23 231 -25 247 -9 8 8 3 55 -21 174
-18 90 -39 197 -47 238 -8 41 -22 105 -30 143 -15 64 -18 67 -45 67 l-29 0 0
134 c0 127 1 134 23 149 12 8 42 33 66 56 34 31 50 39 68 35 13 -4 30 -1 38 6
11 9 32 11 69 6 30 -3 74 -3 98 0 39 5 46 11 60 43 38 86 104 116 161 71 14
-11 28 -20 32 -20 21 0 225 190 225 210 0 6 -9 29 -21 51 -14 28 -18 50 -14
70 7 32 50 89 67 89 5 0 23 9 39 21 l29 20 0 137 c0 153 -8 181 -55 197 -45
15 -54 23 -70 63 -14 33 -14 40 7 100 l23 63 -100 95 c-55 52 -111 98 -124
101 -14 3 -35 -1 -51 -11 -16 -9 -42 -16 -59 -16 -26 0 -36 9 -71 59 -22 33
-40 64 -40 70 0 5 20 17 45 26 72 28 81 44 66 116 -16 80 -8 89 75 89 56 0 68
4 95 28 23 21 32 39 36 72 5 44 4 46 -46 88 -28 24 -51 52 -51 62 0 11 23 42
50 69 56 56 63 85 30 138 -23 38 -66 52 -137 46 -30 -3 -53 -1 -57 5 -4 6 -1
42 5 79 13 75 20 64 -71 123 -25 16 -53 30 -64 30 -10 0 -40 -22 -66 -50 -39
-41 -54 -50 -83 -50 -28 0 -43 9 -83 50 -27 28 -56 50 -65 50 -8 0 -35 -12
-60 -28z m83 -129 c38 -37 40 -38 121 -39 l82 -1 37 39 c54 56 68 51 68 -22 0
-109 37 -147 146 -152 l69 -3 -52 -49 c-51 -48 -53 -52 -53 -103 0 -56 5 -64
70 -115 19 -15 32 -29 29 -32 -3 -3 -36 -8 -72 -11 -76 -5 -97 -16 -122 -58
-14 -24 -16 -43 -11 -97 8 -86 -5 -93 -58 -33 l-38 43 -92 0 -92 0 -39 -40
c-21 -22 -45 -40 -52 -40 -16 0 -17 32 -3 80 9 31 6 40 -24 86 l-35 52 -70 4
c-38 2 -74 7 -78 12 -8 7 16 30 71 69 23 16 26 25 26 77 0 58 -1 59 -50 102
-27 24 -50 46 -50 51 0 4 29 7 64 7 83 0 91 4 128 57 28 42 30 48 19 83 -24
81 -1 93 61 33z m-957 -243 c12 -37 33 -51 105 -71 25 -7 71 -26 104 -43 55
-29 59 -30 70 -13 30 49 29 49 66 19 34 -29 34 -29 17 -55 -23 -35 -22 -40 16
-78 46 -47 101 -144 133 -236 32 -93 50 -116 80 -109 17 5 23 0 28 -17 12 -45
7 -56 -33 -68 -38 -11 -39 -12 -59 -96 -29 -115 -89 -236 -151 -303 -28 -30
-51 -57 -51 -60 0 -4 7 -15 15 -26 21 -27 19 -39 -10 -58 -24 -16 -27 -15 -54
5 l-30 22 -48 -20 c-47 -20 -85 -30 -191 -54 -58 -12 -82 -36 -82 -82 0 -27
-2 -28 -42 -25 -43 3 -43 3 -46 44 -4 52 -20 66 -102 88 -36 10 -88 31 -116
47 -61 34 -71 35 -99 9 l-21 -20 -24 25 c-20 21 -21 28 -11 53 14 34 4 67 -29
97 -24 21 -74 124 -85 173 -9 43 -38 66 -74 59 -25 -5 -31 -2 -42 24 -13 33
-3 49 32 49 28 0 37 22 53 125 8 55 21 115 29 134 19 44 12 67 -24 80 -33 12
-36 26 -10 60 17 22 21 23 51 12 37 -13 34 -14 127 76 50 49 53 55 53 102 0
46 3 52 30 66 29 15 31 15 39 -8 13 -32 37 -40 71 -23 16 7 70 24 121 37 90
22 92 23 107 61 14 35 19 39 45 36 25 -2 33 -10 42 -38z m1193 -739 c23 -55
63 -83 140 -96 33 -5 52 -2 88 15 l46 23 46 -46 45 -45 -26 -32 c-31 -37 -32
-46 -11 -97 61 -144 74 -165 114 -181 l40 -17 0 -66 c0 -62 -2 -67 -23 -73
-49 -12 -105 -96 -138 -204 -11 -38 -10 -43 15 -73 l27 -32 -47 -48 -47 -48
-38 25 c-46 29 -90 30 -144 5 -47 -22 -79 -55 -92 -96 -9 -29 -13 -30 -71 -33
l-61 -3 -10 39 c-13 48 -34 68 -100 93 -64 24 -89 24 -121 -1 -34 -27 -45 -25
-101 15 l-48 36 25 37 c33 47 28 76 -28 190 -38 76 -47 88 -73 92 -27 5 -30 9
-33 45 -6 64 6 98 40 120 35 22 50 46 92 149 33 77 29 118 -12 124 -29 4 -28
16 3 36 14 9 34 34 45 56 l20 40 40 -21 c95 -50 238 -1 254 87 l7 34 58 0 58
0 21 -49z m-1922 -218 c3 -10 10 -25 15 -33 35 -55 38 -75 21 -124 l-17 -47
65 -62 c116 -111 142 -123 187 -87 22 17 28 18 56 6 99 -42 107 -49 119 -93
16 -66 33 -73 171 -73 l118 0 23 53 c23 50 26 53 77 66 30 8 60 16 66 18 7 3
21 -9 30 -26 26 -45 55 -40 156 28 l87 60 0 -69 c0 -47 6 -78 17 -99 20 -34
57 -54 84 -46 14 5 19 1 19 -14 0 -11 5 -31 11 -45 10 -20 8 -33 -10 -70 -11
-25 -21 -49 -21 -53 0 -9 -106 -109 -198 -184 l-72 -61 -101 89 c-125 109
-123 107 -142 100 -23 -9 -48 -52 -41 -70 3 -9 45 -51 92 -93 48 -43 91 -83
95 -90 8 -15 8 -15 -96 -101 -82 -68 -101 -99 -84 -134 19 -37 57 -36 100 3
40 37 114 101 166 144 19 16 73 63 120 105 47 42 97 84 110 95 13 10 44 36 68
57 46 39 55 39 88 2 6 -7 35 -30 65 -53 l54 -41 22 20 c33 31 94 36 118 10 14
-15 17 -26 10 -40 -8 -18 -107 -101 -149 -126 -15 -9 -16 -32 -15 -212 1 -199
0 -202 -22 -217 -13 -9 -66 -52 -118 -96 -214 -179 -305 -252 -332 -266 -33
-17 -16 -28 -179 105 -98 80 -135 111 -220 185 -20 17 -60 51 -88 75 l-51 43
0 183 c0 157 -2 184 -16 196 -13 10 -66 15 -203 19 -173 5 -189 7 -235 30 -75
37 -85 58 -90 175 -3 90 -37 247 -63 287 -3 6 -7 24 -8 40 -3 37 -38 74 -95
102 -45 22 -45 22 -43 70 3 41 11 58 60 122 32 42 72 96 90 122 72 105 94 132
109 132 8 0 17 -8 20 -17z m1314 -43 c0 -17 -27 -77 -38 -84 -19 -12 -19 32 0
63 20 31 38 41 38 21z m-846 -1553 c47 -41 68 -59 116 -97 76 -59 81 -64 134
-111 28 -26 62 -56 76 -67 l25 -20 -45 -6 c-112 -14 -234 -26 -338 -32 l-113
-7 5 24 c3 13 10 53 16 89 18 104 40 212 51 248 12 36 9 37 73 -21z m1135
-148 c18 -99 31 -182 28 -185 -4 -4 -214 12 -267 20 -8 2 -49 6 -91 10 -42 5
-81 11 -88 15 -10 7 174 163 314 268 24 17 46 37 50 42 3 6 9 11 14 11 4 0 22
-81 40 -181z"/>
<path d="M3180 3892 c-81 -36 -130 -127 -110 -204 22 -78 100 -138 182 -138
38 0 99 23 97 38 -1 20 -64 55 -102 57 -28 2 -46 9 -59 25 -32 39 -33 67 -4
105 25 32 31 35 81 35 34 0 55 5 58 13 2 6 7 10 10 7 4 -3 0 -18 -7 -32 -8
-15 -10 -31 -5 -39 5 -8 7 -21 4 -29 -11 -41 -14 -91 -5 -85 5 3 8 0 5 -7 -3
-7 5 -19 17 -27 20 -12 24 -11 45 15 61 77 27 223 -62 260 -35 14 -118 18
-145 6z m167 -244 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z"/>
<path d="M1913 3682 c-82 -29 -123 -49 -160 -79 -113 -96 -169 -183 -194 -301
-23 -109 -23 -165 0 -273 28 -135 83 -219 211 -320 117 -93 318 -126 476 -79
38 12 80 26 94 33 70 33 200 160 236 229 95 184 77 449 -42 605 -51 67 -159
149 -230 176 -159 59 -238 61 -391 9z m288 -83 c111 -35 229 -128 283 -223 92
-161 65 -364 -68 -518 -22 -26 -45 -48 -50 -48 -6 0 -19 -9 -30 -19 -29 -27
-114 -59 -192 -71 -105 -17 -201 9 -326 88 -63 39 -137 156 -164 257 -57 213
91 459 319 531 52 16 182 18 228 3z"/>
<path d="M2057 3373 c-19 -5 -44 -51 -102 -185 -21 -49 -41 -88 -45 -88 -8 0
-17 25 -65 169 -26 78 -57 107 -98 92 -22 -9 -27 -17 -27 -46 0 -19 9 -61 19
-92 10 -32 36 -111 56 -175 44 -141 69 -182 111 -186 38 -4 45 4 88 105 48
113 88 193 96 193 4 0 14 -17 23 -37 52 -125 101 -230 114 -245 9 -10 28 -18
43 -18 50 0 68 35 159 312 22 70 41 135 41 145 0 28 -20 43 -56 43 -35 0 -50
-14 -64 -57 -5 -15 -24 -71 -43 -123 l-35 -94 -35 74 c-19 41 -44 97 -56 125
-37 83 -65 103 -124 88z"/>
<path d="M3185 2891 c-118 -33 -200 -113 -243 -235 -20 -59 -23 -82 -18 -138
11 -117 71 -219 171 -288 80 -55 247 -65 338 -21 68 33 142 105 173 169 36 75
45 204 20 280 -40 119 -140 208 -263 236 -87 19 -102 19 -178 -3z m200 -112
c167 -88 205 -287 78 -410 -65 -63 -104 -81 -177 -82 -69 0 -129 25 -184 77
-133 124 -85 345 90 421 51 22 146 19 193 -6z"/>
</g>
</svg>

    </a>
    Torch Choice
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data_management/" class="md-nav__link">
        Data Management
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../easy_data_management/" class="md-nav__link">
        Easy Data Management and Stata Users
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../conditional_logit_model_mode_canada/" class="md-nav__link">
        Conditional Logit Model
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Nested Logit Model
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Nested Logit Model
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nested-logit-model-background" class="md-nav__link">
    Nested Logit Model: Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-essential-packages" class="md-nav__link">
    Load Essential Packages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-datasets" class="md-nav__link">
    Load Datasets
  </a>
  
    <nav class="md-nav" aria-label="Load Datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nest-level-dataset" class="md-nav__link">
    Nest Level Dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#item-level-dataset" class="md-nav__link">
    Item Level Dataset
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1" class="md-nav__link">
    Example 1
  </a>
  
    <nav class="md-nav" aria-label="Example 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-output" class="md-nav__link">
    R Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2" class="md-nav__link">
    Example 2
  </a>
  
    <nav class="md-nav" aria-label="Example 2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-output_1" class="md-nav__link">
    R Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3" class="md-nav__link">
    Example 3
  </a>
  
    <nav class="md-nav" aria-label="Example 3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-output_2" class="md-nav__link">
    R Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../post_estimation_demos/" class="md-nav__link">
        Post Estimation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../coefficient_initialization/" class="md-nav__link">
        Coefficient Initialization
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projects/" class="md-nav__link">
        Related Projects
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../test/" class="md-nav__link">
        Compatibility Tests
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../api_torch_choice/" class="md-nav__link">
        API Reference Torch-Choice
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nested-logit-model-background" class="md-nav__link">
    Nested Logit Model: Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-essential-packages" class="md-nav__link">
    Load Essential Packages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-datasets" class="md-nav__link">
    Load Datasets
  </a>
  
    <nav class="md-nav" aria-label="Load Datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nest-level-dataset" class="md-nav__link">
    Nest Level Dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#item-level-dataset" class="md-nav__link">
    Item Level Dataset
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1" class="md-nav__link">
    Example 1
  </a>
  
    <nav class="md-nav" aria-label="Example 1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-output" class="md-nav__link">
    R Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2" class="md-nav__link">
    Example 2
  </a>
  
    <nav class="md-nav" aria-label="Example 2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-output_1" class="md-nav__link">
    R Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3" class="md-nav__link">
    Example 3
  </a>
  
    <nav class="md-nav" aria-label="Example 3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-output_2" class="md-nav__link">
    R Output
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="random-utility-model-rum-part-ii-nested-logit-model">Random Utility Model (RUM) Part II: Nested Logit Model</h1>
<p>Author: Tianyu Du</p>
<p>The package implements the nested logit model as well, which allows researchers to model choices as a two-stage process: the user first picks a nest of purchase and then picks the item from the chosen nest that generates the most utility.</p>
<p>Examples here are modified from <a href="https://cran.r-project.org/web/packages/mlogit/vignettes/e2nlogit.html">Exercise 2: Nested logit model by Kenneth Train and Yves Croissant</a>.</p>
<p>The House Cooling (HC) dataset from <code>mlogit</code> contains data in R format on the choice of heating and central cooling system for 250 single-family, newly built houses in California.</p>
<p>The dataset is small and serve as a demonstration of the nested logit model.</p>
<p>The alternatives are:</p>
<ul>
<li>Gas central heat with cooling <code>gcc</code>,</li>
<li>Electric central resistence heat with cooling <code>ecc</code>,</li>
<li>Electric room resistence heat with cooling <code>erc</code>,</li>
<li>Electric heat pump, which provides cooling also <code>hpc</code>,</li>
<li>Gas central heat without cooling <code>gc</code>,</li>
<li>Electric central resistence heat without cooling <code>ec</code>,</li>
<li>Electric room resistence heat without cooling <code>er</code>.</li>
<li>Heat pumps necessarily provide both heating and cooling such that heat pump without cooling is not an alternative.</li>
</ul>
<p>The variables are:</p>
<ul>
<li><code>depvar</code> gives the name of the chosen alternative,</li>
<li><code>ich.alt</code> are the installation cost for the heating portion of the system,</li>
<li><code>icca</code> is the installation cost for cooling</li>
<li><code>och.alt</code> are the operating cost for the heating portion of the system</li>
<li><code>occa</code> is the operating cost for cooling</li>
<li><code>income</code> is the annual income of the household</li>
</ul>
<p>Note that the full installation cost of alternative gcc is ich.gcc+icca, and similarly for the operating cost and for the other alternatives with cooling.</p>
<h2 id="nested-logit-model-background">Nested Logit Model: Background</h2>
<p>The following code block provides an example initialization of the <code>NestedLogitModel</code> (please refer to examples below for details).
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogitModel</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">=</span><span class="n">nest_to_item</span><span class="p">,</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>                         <span class="n">nest_coef_variation_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>                         <span class="n">nest_num_param_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>                         <span class="n">item_coef_variation_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="s1">&#39;constant&#39;</span><span class="p">},</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                         <span class="n">item_num_param_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                         <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></p>
<p>The nested logit model decompose the utility of choosing item <span class="arithmatex">\(i\)</span> into the (1) item-specific values and (2) nest specify values.  For simplicity, suppose item <span class="arithmatex">\(i\)</span>  belongs to nest <span class="arithmatex">\(k \in \{1, \dots, K\}\)</span>: <span class="arithmatex">\(i \in B_k\)</span>.</p>
<div class="arithmatex">\[
U_{uit} = W_{ukt} + Y_{uit}
\]</div>
<p>Where both <span class="arithmatex">\(W\)</span> and <span class="arithmatex">\(Y\)</span> are estimated using linear models from as in the conditional logit model.</p>
<p>The log-likelihood for user <span class="arithmatex">\(u\)</span> to choose item <span class="arithmatex">\(i\)</span> at time/session <span class="arithmatex">\(t\)</span> decomposes into the item-level likelihood and nest-level likelihood.</p>
<div class="arithmatex">\[
\log P(i \mid u, t) = \log P(i \mid u, t, B_k) + \log P(k \mid u, t) \\
= \log \left(\frac{\exp(Y_{uit}/\lambda_k)}{\sum_{j \in B_k} \exp(Y_{ujt}/\lambda_k)}\right) + \log \left( \frac{\exp(W_{ukt} + \lambda_k I_{ukt})}{\sum_{\ell=1}^K \exp(W_{u\ell t} + \lambda_\ell I_{u\ell t})}\right)
\]</div>
<p>The <strong>inclusive value</strong> of nest <span class="arithmatex">\(k\)</span>, <span class="arithmatex">\(I_{ukt}\)</span> is defined as <span class="arithmatex">\(\log \sum_{j \in B_k} \exp(Y_{ujt}/\lambda_k)\)</span>, which is the <em>expected utility from choosing the best alternative from nest <span class="arithmatex">\(k\)</span></em>.</p>
<p>The <code>nest_to_item</code> keyword defines a dictionary of the mapping <span class="arithmatex">\(k \mapsto B_k\)</span>, where keys of <code>nest_to_item</code>  are integer <span class="arithmatex">\(k\)</span>'s and  <code>nest_to_item[k]</code>  is a list consisting of IDs of items in <span class="arithmatex">\(B_k\)</span>.</p>
<p>The <code>{nest, item}_coef_variation_dict</code> provides specification to <span class="arithmatex">\(W_{ukt}\)</span> and <span class="arithmatex">\(Y_{uit}\)</span> respectively, <code>torch_choice</code> allows for empty nest level models by providing an empty dictionary (in this case, <span class="arithmatex">\(W_{ukt} = \epsilon_{ukt}\)</span>) since the inclusive value term <span class="arithmatex">\(\lambda_k I_{ukt}\)</span> will be used to model the choice over nests. However, by specifying an empty second stage model (<span class="arithmatex">\(Y_{uit} = \epsilon_{uit}\)</span>), the nested logit model reduces to a conditional logit model of choices over nests. Hence, one should never use the <code>NestedLogitModel</code> class with an empty item-level model.</p>
<p>Similar to the conditional logit model, <code>{nest, item}_num_param_dict</code> specify the dimension (number of observables to be multiplied with the coefficient) of coefficients. The above code initializes a simple model built upon item-time-specific observables <span class="arithmatex">\(X_{it} \in \mathbb{R}^7\)</span>,</p>
<div class="arithmatex">\[
Y_{uit} = \beta^\top X_{it} + \epsilon_{uit} \\
W_{ukt} = \epsilon_{ukt}
\]</div>
<p>The research may wish to enfoce the <em>elasiticity</em> <span class="arithmatex">\(\lambda_k\)</span> to be constant across nests, setting <code>shared_lambda=True</code> enforces <span class="arithmatex">\(\lambda_k = \lambda\ \forall k \in [K]\)</span>.</p>
<h2 id="load-essential-packages">Load Essential Packages</h2>
<p>We firstly read essential packages for this tutorial.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># ignore warnings for nicer outputs.</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kn">import</span> <span class="nn">torch</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="kn">from</span> <span class="nn">torch_choice.data</span> <span class="kn">import</span> <span class="n">ChoiceDataset</span><span class="p">,</span> <span class="n">JointDataset</span><span class="p">,</span> <span class="n">utils</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="kn">from</span> <span class="nn">torch_choice.model.nested_logit_model</span> <span class="kn">import</span> <span class="n">NestedLogitModel</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="kn">from</span> <span class="nn">torch_choice</span> <span class="kn">import</span> <span class="n">run</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2.0.0
</code></pre></div>
<p>We then select the appropriate device to run the model on, our package supports both CPU and GPU.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CUDA device used: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running tutorial on CPU&#39;</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Running tutorial on CPU
</code></pre></div>
<h2 id="load-datasets">Load Datasets</h2>
<p>We firstly read the dataset for this tutorial, the <code>csv</code> file can be found at <code>./public_datasets/HC.csv</code>.
Alternatively, we load the dataset directly from the Github website.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/gsbDBI/torch-choice/main/tutorials/public_datasets/HC.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>depvar</th>
      <th>icca</th>
      <th>occa</th>
      <th>income</th>
      <th>ich</th>
      <th>och</th>
      <th>idx.id1</th>
      <th>idx.id2</th>
      <th>inc.room</th>
      <th>inc.cooling</th>
      <th>int.cooling</th>
      <th>cooling.modes</th>
      <th>room.modes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>20</td>
      <td>24.50</td>
      <td>4.09</td>
      <td>1</td>
      <td>ec</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>27.28</td>
      <td>2.95</td>
      <td>20</td>
      <td>7.86</td>
      <td>4.09</td>
      <td>1</td>
      <td>ecc</td>
      <td>0</td>
      <td>20</td>
      <td>1</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>False</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>20</td>
      <td>7.37</td>
      <td>3.85</td>
      <td>1</td>
      <td>er</td>
      <td>20</td>
      <td>0</td>
      <td>0</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>True</td>
      <td>27.28</td>
      <td>2.95</td>
      <td>20</td>
      <td>8.79</td>
      <td>3.85</td>
      <td>1</td>
      <td>erc</td>
      <td>20</td>
      <td>20</td>
      <td>1</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>False</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>20</td>
      <td>24.08</td>
      <td>2.26</td>
      <td>1</td>
      <td>gc</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>

<p>The raw dataset is in a long-format (i.e., each row contains information of one item).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;idx.id2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>ec     250
ecc    250
er     250
erc    250
gc     250
gcc    250
hpc    250
Name: idx.id2, dtype: int64
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># what was actually chosen.</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">item_index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;depvar&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;idx.id1&#39;</span><span class="p">)[</span><span class="s1">&#39;idx.id2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">item_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ec&#39;</span><span class="p">,</span> <span class="s1">&#39;ecc&#39;</span><span class="p">,</span> <span class="s1">&#39;er&#39;</span><span class="p">,</span> <span class="s1">&#39;erc&#39;</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;gcc&#39;</span><span class="p">,</span> <span class="s1">&#39;hpc&#39;</span><span class="p">]</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">num_items</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;idx.id2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="c1"># cardinal encoder.</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="n">encoder</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">item_names</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_items</span><span class="p">)))</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">item_index</span> <span class="o">=</span> <span class="n">item_index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">encoder</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">item_index</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">item_index</span><span class="p">)</span>
</code></pre></div>
<p>Because we will be training our model with <code>PyTorch</code>, we need to encode item names to integers (from 0 to 6).
We do this manually in this exercise given the small amount of items, for more items, one can use <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.OrdinalEncoder.html">sklearn.preprocessing.OrdinalEncoder</a> to encode.</p>
<p>Raw item names will be encoded as the following.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">encoder</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>{&#39;ec&#39;: 0, &#39;ecc&#39;: 1, &#39;er&#39;: 2, &#39;erc&#39;: 3, &#39;gc&#39;: 4, &#39;gcc&#39;: 5, &#39;hpc&#39;: 6}
</code></pre></div>
<h3 id="nest-level-dataset">Nest Level Dataset</h3>
<p>We firstly construct the nest-level dataset, however, there is no observable that is constant within the same nest, so we don't need to include any observable tensor to the <code>nest_dataset</code>.</p>
<p>All we need to do is adding the <code>item_index</code> (i.e., which item is chosen) to the dataset, so that <code>nest_dataset</code> knows the total number of choices made.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># nest feature: no nest feature, all features are item-level.</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">nest_dataset</span> <span class="o">=</span> <span class="n">ChoiceDataset</span><span class="p">(</span><span class="n">item_index</span><span class="o">=</span><span class="n">item_index</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>No `session_index` is provided, assume each choice instance is in its own session.
</code></pre></div>
<h3 id="item-level-dataset">Item Level Dataset</h3>
<p>For simplicity, we treat each purchasing record as its own session. Moreover, we treat all observables as price observables (i.e., varying by both session and item).</p>
<p>Since there are 7 observables in total, the resulted <code>price_obs</code> has shape (250, 7, 7) corresponding to <code>number_of_sessions</code> by <code>number_of_items</code> by <code>number_of_observables</code>. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># item feature.</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">item_feat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ich&#39;</span><span class="p">,</span> <span class="s1">&#39;och&#39;</span><span class="p">,</span> <span class="s1">&#39;icca&#39;</span><span class="p">,</span> <span class="s1">&#39;occa&#39;</span><span class="p">,</span> <span class="s1">&#39;inc.room&#39;</span><span class="p">,</span> <span class="s1">&#39;inc.cooling&#39;</span><span class="p">,</span> <span class="s1">&#39;int.cooling&#39;</span><span class="p">]</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">price_obs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">pivot3d</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dim0</span><span class="o">=</span><span class="s1">&#39;idx.id1&#39;</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=</span><span class="s1">&#39;idx.id2&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">item_feat_cols</span><span class="p">)</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">price_obs</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([250, 7, 7])
</code></pre></div>
<p>Then, we construct the item level dataset by providing both <code>item_index</code> and <code>price_obs</code>.</p>
<p>We move <code>item_dataset</code> to the appropriate device as well. This is only necessary if we are using GPU to accelerate the model.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">item_dataset</span> <span class="o">=</span> <span class="n">ChoiceDataset</span><span class="p">(</span><span class="n">item_index</span><span class="o">=</span><span class="n">item_index</span><span class="p">,</span> <span class="n">price_obs</span><span class="o">=</span><span class="n">price_obs</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>No `session_index` is provided, assume each choice instance is in its own session.
</code></pre></div>
<p>Finally, we chain the nest-level and item-level dataset into a single <code>JointDataset</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">JointDataset</span><span class="p">(</span><span class="n">nest</span><span class="o">=</span><span class="n">nest_dataset</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item_dataset</span><span class="p">)</span>
</code></pre></div>
<p>One can print the joint dataset to see its contents, and tensors contained in each of these sub-datasets.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>JointDataset with 2 sub-datasets: (
    nest: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], device=cpu)
    item: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], price_obs=[250, 7, 7], device=cpu)
)
</code></pre></div>
<h2 id="examples">Examples</h2>
<p>There are multiple ways to group 7 items into nests, different classification will result in different utility functions and estimations (see the background of nested logit models).</p>
<p>We will demonstrate the usage of our package by presenting three different categorization schemes and corresponding model estimations.</p>
<h3 id="example-1">Example 1</h3>
<p>In the first example, the model is specified to have the <em>cooling alternatives</em> <code>{gcc, ecc, erc, hpc}</code> in one nest and the <em>non-cooling alternatives</em> <code>{gc, ec, er}</code> in another nest.</p>
<p>We create a <code>nest_to_item</code> dictionary to inform the model our categorization scheme. The dictionary should have keys ranging from <code>0</code> to <code>number_of_nests - 1</code>, each integer corresponds to a nest. The value of each key is a list of item IDs in the nest, the encoding of item names should be exactly the same as in the construction of <code>item_index</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">nest_to_item</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gcc&#39;</span><span class="p">,</span> <span class="s1">&#39;ecc&#39;</span><span class="p">,</span> <span class="s1">&#39;erc&#39;</span><span class="p">,</span> <span class="s1">&#39;hpc&#39;</span><span class="p">],</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;ec&#39;</span><span class="p">,</span> <span class="s1">&#39;er&#39;</span><span class="p">]}</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># encode items to integers.</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nest_to_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">encoder</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">nest_to_item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</code></pre></div>
<p>In this example, we have item <code>[1, 3, 5, 6]</code> in the first nest (i.e., the nest with ID <code>0</code>) and the rest of items in the second nest (i.e., the nest with ID <code>1</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">nest_to_item</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>{0: [1, 3, 5, 6], 1: [0, 2, 4]}
</code></pre></div>
<p>Next, let's create the <code>NestedLogitModel</code> class!</p>
<p>The first thing to put in is the <code>nest_to_item</code> dictionary we just built.</p>
<p>For <code>nest_coef_variation_dict</code>, <code>nest_num_param_dict</code>, since we don't have any nest-specific observables, we can simply put an empty dictionary there.</p>
<p>Coefficients for all observables are constant across items, and there are 7 observables in total.</p>
<p>As for <code>shared_lambda=True</code>, please refer to the background recap for nested logit model.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogitModel</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">=</span><span class="n">nest_to_item</span><span class="p">,</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>                         <span class="n">nest_coef_variation_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>                         <span class="n">nest_num_param_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>                         <span class="n">item_coef_variation_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="s1">&#39;constant&#39;</span><span class="p">},</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>                         <span class="n">item_num_param_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>                         <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogitModel</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">=</span><span class="n">nest_to_item</span><span class="p">,</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>                         <span class="n">nest_formula</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>                         <span class="n">item_formula</span><span class="o">=</span><span class="s1">&#39;(price_obs|constant)&#39;</span><span class="p">,</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>                         <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>                         <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</code></pre></div>
<p>You can print the model to get summary information of the <code>NestedLogitModel</code> class.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
</code></pre></div>
<p><strong>NOTE</strong>: We are computing the standard errors using <span class="arithmatex">\(\sqrt{\text{diag}(H^{-1})}\)</span>, where <span class="arithmatex">\(H\)</span> is the
hessian of negative log-likelihood with respect to model parameters. This leads to slight different
results compared with R implementation.</p>
<p>Here we use the LBFGS optimizer since we are working on a small dataset and 8 coefficients to be estimated. For larger datasets and larger models, we recommend using the Adam optimizer instead.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">model_optimizer</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>==================== model received ====================
NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
==================== data set received ====================
[Train dataset] JointDataset with 2 sub-datasets: (
    nest: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], device=cpu)
    item: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], price_obs=[250, 7, 7], device=cpu)
)
[Validation dataset] None
[Test dataset] None


GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs

  | Name  | Type             | Params
-------------------------------------------
0 | model | NestedLogitModel | 8     
-------------------------------------------
8         Trainable params
0         Non-trainable params
8         Total params
0.000     Total estimated model params size (MB)


Epoch 999: 100%|| 1/1 [00:00&lt;00:00, 136.14it/s, loss=178, v_num=29]

`Trainer.fit` stopped: `max_epochs=1000` reached.


Epoch 999: 100%|| 1/1 [00:00&lt;00:00, 121.79it/s, loss=178, v_num=29]
Time taken for training: 13.282686233520508
Skip testing, no test dataset is provided.
==================== model results ====================
Log-likelihood: [Training] -178.124755859375, [Validation] N/A, [Test] N/A

| Coefficient                |   Estimation |   Std. Err. |   z-value |    Pr(&gt;|z|) | Significance   |
|:---------------------------|-------------:|------------:|----------:|------------:|:---------------|
| lambda_weight_0            |     0.585898 |   0.166624  |   3.51628 | 0.000437634 | ***            |
| item_price_obs[constant]_0 |    -0.554846 |   0.144515  |  -3.83936 | 0.000123357 | ***            |
| item_price_obs[constant]_1 |    -0.857842 |   0.237496  |  -3.61203 | 0.000303804 | ***            |
| item_price_obs[constant]_2 |    -0.225084 |   0.110576  |  -2.03556 | 0.0417943   | *              |
| item_price_obs[constant]_3 |    -1.08945  |   1.03675   |  -1.05084 | 0.293332    |                |
| item_price_obs[constant]_4 |    -0.37895  |   0.100705  |  -3.76299 | 0.000167895 | ***            |
| item_price_obs[constant]_5 |     0.249572 |   0.0518543 |   4.81295 | 1.4872e-06  | ***            |
| item_price_obs[constant]_6 |    -5.99973  |   4.82952   |  -1.2423  | 0.214124    |                |
Significance codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1





NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
</code></pre></div>
<h4 id="r-output">R Output</h4>
<p>Here we provide the output from <code>mlogit</code> model in <code>R</code> for estimation reference.</p>
<p>Coefficient names reported are slightly different in <code>Python</code> and <code>R</code>, please use the following table for comparison. Please note that the <code>lambda_weight_0</code> in <code>Python</code> (at the top) corresponds to the <code>iv</code> (inclusive value) in <code>R</code> (at the bottom). Orderings of coefficients for observables should be the same in both languages.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Coefficient (Python)</th>
<th style="text-align: center;">Coefficient (R)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">lambda_weight_0</td>
<td style="text-align: center;">iv</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_0</td>
<td style="text-align: center;">ich</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_1</td>
<td style="text-align: center;">och</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_2</td>
<td style="text-align: center;">icca</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_3</td>
<td style="text-align: center;">occa</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_4</td>
<td style="text-align: center;">inc.room</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_5</td>
<td style="text-align: center;">inc.cooling</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_6</td>
<td style="text-align: center;">int.cooling</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>## 
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>## Call:
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>## mlogit(formula = depvar ~ ich + och + icca + occa + inc.room + 
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>##     inc.cooling + int.cooling | 0, data = HC, nests = list(cooling = c(&quot;gcc&quot;, 
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>##     &quot;ecc&quot;, &quot;erc&quot;, &quot;hpc&quot;), other = c(&quot;gc&quot;, &quot;ec&quot;, &quot;er&quot;)), un.nest.el = TRUE)
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>## 
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>## Frequencies of alternatives:choice
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>##    ec   ecc    er   erc    gc   gcc   hpc 
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>## 0.004 0.016 0.032 0.004 0.096 0.744 0.104 
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>## 
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>## bfgs method
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>## 11 iterations, 0h:0m:0s 
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>## g&#39;(-H)^-1g = 7.26E-06 
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>## successive function values within tolerance limits 
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>## 
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>## Coefficients :
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>##              Estimate Std. Error z-value  Pr(&gt;|z|)    
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>## ich         -0.554878   0.144205 -3.8478 0.0001192 ***
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>## och         -0.857886   0.255313 -3.3601 0.0007791 ***
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>## icca        -0.225079   0.144423 -1.5585 0.1191212    
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>## occa        -1.089458   1.219821 -0.8931 0.3717882    
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>## inc.room    -0.378971   0.099631 -3.8038 0.0001425 ***
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>## inc.cooling  0.249575   0.059213  4.2149 2.499e-05 ***
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>## int.cooling -6.000415   5.562423 -1.0787 0.2807030    
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>## iv           0.585922   0.179708  3.2604 0.0011125 ** 
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>## ---
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>## 
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>## Log-Likelihood: -178.12
</code></pre></div>
<h3 id="example-2">Example 2</h3>
<p>The second example is similar to the first one, but we change the way we group items into different nests.
Re-estimate the model with the room alternatives in one nest and the central alternatives in another nest. (Note that a heat pump is a central system.)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">nest_to_item</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ec&#39;</span><span class="p">,</span> <span class="s1">&#39;ecc&#39;</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;gcc&#39;</span><span class="p">,</span> <span class="s1">&#39;hpc&#39;</span><span class="p">],</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>                    <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;er&#39;</span><span class="p">,</span> <span class="s1">&#39;erc&#39;</span><span class="p">]}</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nest_to_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">encoder</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="n">nest_to_item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># these two initializations are equivalent.</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogitModel</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">=</span><span class="n">nest_to_item</span><span class="p">,</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>                         <span class="n">nest_coef_variation_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>                         <span class="n">nest_num_param_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>                         <span class="n">item_coef_variation_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="s1">&#39;constant&#39;</span><span class="p">},</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>                         <span class="n">item_num_param_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>                         <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogitModel</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">=</span><span class="n">nest_to_item</span><span class="p">,</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>                         <span class="n">nest_formula</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>                         <span class="n">item_formula</span><span class="o">=</span><span class="s1">&#39;(price_obs|constant)&#39;</span><span class="p">,</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>                         <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>                         <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">model_optimizer</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>==================== model received ====================
NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
==================== data set received ====================
[Train dataset] JointDataset with 2 sub-datasets: (
    nest: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], device=cpu)
    item: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], price_obs=[250, 7, 7], device=cpu)
)
[Validation dataset] None
[Test dataset] None


GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs

  | Name  | Type             | Params
-------------------------------------------
0 | model | NestedLogitModel | 8     
-------------------------------------------
8         Trainable params
0         Non-trainable params
8         Total params
0.000     Total estimated model params size (MB)


Epoch 999: 100%|| 1/1 [00:00&lt;00:00, 116.29it/s, loss=180, v_num=30]

`Trainer.fit` stopped: `max_epochs=1000` reached.


Epoch 999: 100%|| 1/1 [00:00&lt;00:00, 107.92it/s, loss=180, v_num=30]
Time taken for training: 7.460475206375122
Skip testing, no test dataset is provided.
==================== model results ====================
Log-likelihood: [Training] -180.02308654785156, [Validation] N/A, [Test] N/A

| Coefficient                |   Estimation |   Std. Err. |   z-value |   Pr(&gt;|z|) | Significance   |
|:---------------------------|-------------:|------------:|----------:|-----------:|:---------------|
| lambda_weight_0            |     1.3621   |    0.55502  |   2.45415 | 0.0141217  | *              |
| item_price_obs[constant]_0 |    -1.13826  |    0.444239 |  -2.56226 | 0.0103993  | *              |
| item_price_obs[constant]_1 |    -1.82546  |    0.738092 |  -2.47321 | 0.0133906  | *              |
| item_price_obs[constant]_2 |    -0.337469 |    0.20258  |  -1.66585 | 0.0957429  |                |
| item_price_obs[constant]_3 |    -2.06347  |    1.76159  |  -1.17136 | 0.241453   |                |
| item_price_obs[constant]_4 |    -0.757264 |    0.278476 |  -2.71931 | 0.00654181 | **             |
| item_price_obs[constant]_5 |     0.416903 |    0.170012 |   2.4522  | 0.0141987  | *              |
| item_price_obs[constant]_6 |   -13.8256   |    8.09395  |  -1.70814 | 0.0876098  |                |
Significance codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1





NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
</code></pre></div>
<h4 id="r-output_1">R Output</h4>
<p>You can use the table for converting coefficient names reported by <code>Python</code> and <code>R</code>:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Coefficient (Python)</th>
<th style="text-align: center;">Coefficient (R)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">lambda_weight_0</td>
<td style="text-align: center;">iv</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_0</td>
<td style="text-align: center;">ich</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_1</td>
<td style="text-align: center;">och</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_2</td>
<td style="text-align: center;">icca</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_3</td>
<td style="text-align: center;">occa</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_4</td>
<td style="text-align: center;">inc.room</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_5</td>
<td style="text-align: center;">inc.cooling</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_6</td>
<td style="text-align: center;">int.cooling</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>## 
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>## Call:
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>## mlogit(formula = depvar ~ ich + och + icca + occa + inc.room + 
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>##     inc.cooling + int.cooling | 0, data = HC, nests = list(central = c(&quot;ec&quot;, 
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>##     &quot;ecc&quot;, &quot;gc&quot;, &quot;gcc&quot;, &quot;hpc&quot;), room = c(&quot;er&quot;, &quot;erc&quot;)), un.nest.el = TRUE)
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>## 
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>## Frequencies of alternatives:choice
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>##    ec   ecc    er   erc    gc   gcc   hpc 
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>## 0.004 0.016 0.032 0.004 0.096 0.744 0.104 
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>## 
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>## bfgs method
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>## 10 iterations, 0h:0m:0s 
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>## g&#39;(-H)^-1g = 5.87E-07 
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>## gradient close to zero 
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>## 
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>## Coefficients :
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>##              Estimate Std. Error z-value Pr(&gt;|z|)  
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>## ich          -1.13818    0.54216 -2.0993  0.03579 *
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>## och          -1.82532    0.93228 -1.9579  0.05024 .
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>## icca         -0.33746    0.26934 -1.2529  0.21024  
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>## occa         -2.06328    1.89726 -1.0875  0.27681  
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>## inc.room     -0.75722    0.34292 -2.2081  0.02723 *
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>## inc.cooling   0.41689    0.20742  2.0099  0.04444 *
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>## int.cooling -13.82487    7.94031 -1.7411  0.08167 .
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>## iv            1.36201    0.65393  2.0828  0.03727 *
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>## ---
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>## 
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>## Log-Likelihood: -180.02
</code></pre></div>
<h3 id="example-3">Example 3</h3>
<p>For the third example, we now group items into three nests. Specifically, we have items <code>gcc</code>, <code>ecc</code> and <code>erc</code> in the first nest (nest <code>0</code> in the <code>nest_to_item</code> dictionary), <code>hpc</code> in a nest (nest <code>1</code>) alone, and items <code>gc</code>, <code>ec</code> and <code>er</code> in the last nest (nest <code>2</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">nest_to_item</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gcc&#39;</span><span class="p">,</span> <span class="s1">&#39;ecc&#39;</span><span class="p">,</span> <span class="s1">&#39;erc&#39;</span><span class="p">],</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>                <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;hpc&#39;</span><span class="p">],</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>                <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;ec&#39;</span><span class="p">,</span> <span class="s1">&#39;er&#39;</span><span class="p">]}</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nest_to_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">encoder</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">nest_to_item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogitModel</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">=</span><span class="n">nest_to_item</span><span class="p">,</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>                         <span class="n">nest_coef_variation_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>                         <span class="n">nest_num_param_dict</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>                         <span class="n">item_coef_variation_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="s1">&#39;constant&#39;</span><span class="p">},</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>                         <span class="n">item_num_param_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;price_obs&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>                         <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogitModel</span><span class="p">(</span><span class="n">nest_to_item</span><span class="o">=</span><span class="n">nest_to_item</span><span class="p">,</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>                         <span class="n">nest_formula</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>                         <span class="n">item_formula</span><span class="o">=</span><span class="s1">&#39;(price_obs|constant)&#39;</span><span class="p">,</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>                         <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>                         <span class="n">shared_lambda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">model_optimizer</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>==================== model received ====================
NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
==================== data set received ====================
[Train dataset] JointDataset with 2 sub-datasets: (
    nest: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], device=cpu)
    item: ChoiceDataset(label=[], item_index=[250], user_index=[], session_index=[250], item_availability=[], price_obs=[250, 7, 7], device=cpu)
)
[Validation dataset] None
[Test dataset] None


GPU available: True (mps), used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs

  | Name  | Type             | Params
-------------------------------------------
0 | model | NestedLogitModel | 8     
-------------------------------------------
8         Trainable params
0         Non-trainable params
8         Total params
0.000     Total estimated model params size (MB)


Epoch 999: 100%|| 1/1 [00:00&lt;00:00, 142.92it/s, loss=180, v_num=31]

`Trainer.fit` stopped: `max_epochs=1000` reached.


Epoch 999: 100%|| 1/1 [00:00&lt;00:00, 126.62it/s, loss=180, v_num=31]
Time taken for training: 7.50447416305542
Skip testing, no test dataset is provided.
==================== model results ====================
Log-likelihood: [Training] -180.26324462890625, [Validation] N/A, [Test] N/A

| Coefficient                |   Estimation |   Std. Err. |   z-value |    Pr(&gt;|z|) | Significance   |
|:---------------------------|-------------:|------------:|----------:|------------:|:---------------|
| lambda_weight_0            |     0.956541 |   0.197062  |   4.854   | 1.20994e-06 | ***            |
| item_price_obs[constant]_0 |    -0.838394 |   0.099096  |  -8.46042 | 0           | ***            |
| item_price_obs[constant]_1 |    -1.3316   |   0.184895  |  -7.2019  | 5.93747e-13 | ***            |
| item_price_obs[constant]_2 |    -0.25613  |   0.1263    |  -2.02795 | 0.0425655   | *              |
| item_price_obs[constant]_3 |    -1.40566  |   1.14467   |  -1.22801 | 0.219443    |                |
| item_price_obs[constant]_4 |    -0.571352 |   0.0750316 |  -7.61482 | 2.64233e-14 | ***            |
| item_price_obs[constant]_5 |     0.311357 |   0.0550892 |   5.65187 | 1.58715e-08 | ***            |
| item_price_obs[constant]_6 |   -10.4134   |   5.19301   |  -2.00528 | 0.0449335   | *              |
Significance codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1





NestedLogitModel(
  (nest_coef_dict): ModuleDict()
  (item_coef_dict): ModuleDict(
    (price_obs[constant]): Coefficient(variation=constant, num_items=7, num_users=None, num_params=7, 7 trainable parameters in total, device=cpu).
  )
)
</code></pre></div>
<h4 id="r-output_2">R Output</h4>
<p>You can use the table for converting coefficient names reported by <code>Python</code> and <code>R</code>:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Coefficient (Python)</th>
<th style="text-align: center;">Coefficient (R)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">lambda_weight_0</td>
<td style="text-align: center;">iv</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_0</td>
<td style="text-align: center;">ich</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_1</td>
<td style="text-align: center;">och</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_2</td>
<td style="text-align: center;">icca</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_3</td>
<td style="text-align: center;">occa</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_4</td>
<td style="text-align: center;">inc.room</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_5</td>
<td style="text-align: center;">inc.cooling</td>
</tr>
<tr>
<td style="text-align: left;">item_price_obs_6</td>
<td style="text-align: center;">int.cooling</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>## 
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>## Call:
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>## mlogit(formula = depvar ~ ich + och + icca + occa + inc.room + 
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>##     inc.cooling + int.cooling | 0, data = HC, nests = list(n1 = c(&quot;gcc&quot;, 
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>##     &quot;ecc&quot;, &quot;erc&quot;), n2 = c(&quot;hpc&quot;), n3 = c(&quot;gc&quot;, &quot;ec&quot;, &quot;er&quot;)), 
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>##     un.nest.el = TRUE)
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>## 
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>## Frequencies of alternatives:choice
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>##    ec   ecc    er   erc    gc   gcc   hpc 
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>## 0.004 0.016 0.032 0.004 0.096 0.744 0.104 
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>## 
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>## bfgs method
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>## 8 iterations, 0h:0m:0s 
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>## g&#39;(-H)^-1g = 3.71E-08 
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>## gradient close to zero 
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>## 
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>## Coefficients :
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>##               Estimate Std. Error z-value  Pr(&gt;|z|)    
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>## ich          -0.838394   0.100546 -8.3384 &lt; 2.2e-16 ***
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>## och          -1.331598   0.252069 -5.2827 1.273e-07 ***
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>## icca         -0.256131   0.145564 -1.7596   0.07848 .  
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>## occa         -1.405656   1.207281 -1.1643   0.24430    
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>## inc.room     -0.571352   0.077950 -7.3297 2.307e-13 ***
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>## inc.cooling   0.311355   0.056357  5.5247 3.301e-08 ***
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>## int.cooling -10.413384   5.612445 -1.8554   0.06354 .  
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>## iv            0.956544   0.180722  5.2929 1.204e-07 ***
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>## ---
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>## 
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>## Log-Likelihood: -180.26
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../javascripts/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>